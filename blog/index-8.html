<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Racket Blog (page 8)</title>
    <meta name="description" content="Racket Blog (page 8)">
    <meta name="author"      content="The Unknown Author">
    <meta name="keywords"    content="all">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="http://blog.racket-lang.org/index-8.html">


    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/blog-fonts.css">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml" href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    </head>
  <body>
<row class="one-column" id="logo"><col-1><a href="http://racket-lang.org"><div id="logo-container"><img id="logo" src="/img/racket-logo.svg"/> Racket</div></a></col-1><col-2><p><a href="/index.html">blog</a></p></col-2></row>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>28 Feb 2010</p></col-1>

<col-2>
  <h1><a href='/2010/02/dags-vs-trees.html'>DAGs vs Trees</a></h1>
  <div class="truncate">
<p><em>posted by Robby Findler</em></p>

<p>As I wondering whether or not there is a better layout algorithm for the module browser window, I looked into <a href="http://www.cs.umd.edu/hcil/treemap-history/">tree maps</a>. Of course, the modules in a program form a DAG, not a tree, so I wondered just how big the tree would get if all of the shared structure in the DAG were replicated. Hey, I figured, if a tree map can handle showing me my entire filesystem, maybe that could work.</p>

<p>&hellip; yeah, no. Turns out to be hopeless. In the spirit of a geeky take off on a jelly bean counting contest, lets see if you can guess just how big these things get. Consider the module graph from the program <code>#lang scheme</code> (ie, the graph that just contains an empty program). This program loads 170 modules with 917 connections between modules (counting the main file that just contains the <code>#lang scheme</code>).</p>

<p>So, the question: how many nodes are there in the unsharified tree? First one to come within 1 billion of the right answer gets all of the fame and glory that this blog brings to bear (har har). I&rsquo;ll post the answer in the comments in a few days (and no fair cheating, those of you that know enough to be able to get your hands on the DAG).</p></div>
  <a class="more" href='/2010/02/dags-vs-trees.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>29 Jan 2010</p></col-1>

<col-2>
  <h1><a href='/2010/01/benchmarks.html'>Benchmarks</a></h1>
  <div class="truncate">
<p><em>posted by Matthew Flatt</em></p>

<p>First, the usual disclaimer:</p>

<p>That said, I&rsquo;ve run the latest version of PLT Scheme on two sets of benchmarks:</p>

<ul>
 <li>
  <p><a href="http://www.cs.utah.edu/%7Emflatt/benchmarks-20100126/log3/Benchmarks.html">Benchmarks in the PLT sources</a> – vs. Bigloo, Chicken, Gambit, Guile, Ikarus, Larceny, MIT Scheme, and Scheme48; safe operations and generic arithmetic only</p></li>
 <li>
  <p><a href="http://www.cs.utah.edu/%7Emflatt/benchmarks-20100126/log1/Gambit_20benchmarks.html">Benchmarks in the Gambit sources</a> – vs. Bigloo and Gambit; generic vs. fixnum-/flonum-specific arithmetic, safe vs. unsafe operationsThe second set is why I started running benchmarks. Fixnum-/flonum-specific arithmetic and unsafe operations are new in PLT Scheme 4.2.4. The benchmark results suggest that the new operations in PLT Scheme offer roughly the same performance benefits as in Bigloo and Gambit. There&rsquo;s room for improvement, but it&rsquo;s a good first cut.</p></li></ul>

<p>For the other results: PLT Scheme is rarely the fastest implementation on a given benchmark. For most purposes, though, it&rsquo;s in the same ballpark – except for programs that spend all their time capturing and invoking continuations.</p>

<p>It&rsquo;s fun to run benchmarks occasionally. Now, back to working on language design, libraries, documentation, usability&hellip;</p></div>
  <a class="more" href='/2010/01/benchmarks.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>28 Jan 2010</p></col-1>

<col-2>
  <h1><a href='/2010/01/plt-scheme-v424.html'>PLT Scheme v4.2.4</a></h1>
  <div class="truncate">
<p><em>posted by Eli Barzilay</em></p>

<p>PLT Scheme version 4.2.4 is now available from <a href="http://plt-scheme.org/"><code>http://plt-scheme.org/</code></a></p>

<ul>
 <li>The <code>scheme/flonum</code> and <code>scheme/fixnum</code> libraries provide flonum- and fixnum-specific operations. In the case of flonum-specific operations, the JIT compiler can recognize combinations of operations (including local bindings) and improve performance by &ldquo;unboxing&rdquo; intermediate results.</li>
 <li>The <code>scheme/unsafe/ops</code> library provides arithmetic and other operations that are implemented without dynamic checks. Avoiding checks can sometimes improve performance, but at the expense of safety.</li>
 <li><code>2htdp/universe</code>: We have severed the connection between universe and an image library and made a few other, minor changes. Most programs will now have to change to require the <code>htdp/image</code> library explicitly. For the full details, see the new <a href="http://docs.plt-scheme.org/teachpack/2htdphtdp-port.html">Porting World Programs</a> section of the documentation.</li>
 <li>The <code>2htdp/image</code> library continues to grow. In this release, it is supported by <code>2htdp/universe</code>, equality changed to be based on how the images are drawn, cropping and curves were added, and support for more kinds of pens were added.</li>
 <li><code>htdp/world</code>: The old world teachpack remains deprecated. HtDP/2e exclusively uses the new 2htdp/universe library. For backwards compatibility, the world teachpack will remain in the distribution until the coming summer.</li>
 <li>The <code>scheme/class</code> library now provides <code>this%</code>, which refers to the class of the current object (i.e. <code>this</code>).</li>
 <li><code>scheme/generator</code> has convenient functions for infinite generators, and for converting a generator to a sequence for iteration.</li>
 <li>PLT Scheme&rsquo;s add-on directory can be customized by the <code>$PLTADDONDIR</code> environment variable or <code>--addon</code>/<code>-A</code> command-line flags. This controls where downloaded Planet packages and their compiled Scribble documentation are installed.</li>
 <li>Additional extensions include: saving <code>errno</code> in foreign calls, much improved <code>sort</code> speed, normalized results from <code>procedure-arity</code>, and more.</li></ul></div>
  <a class="more" href='/2010/01/plt-scheme-v424.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>02 Jan 2010</p></col-1>

<col-2>
  <h1><a href='/2010/01/scheme-videos-lectures-and-talks.html'>Scheme Videos (Lectures and Talks)</a></h1>
  <div class="truncate">
<p><em>posted by John Clements</em></p>

<p>Scheme Videos (Lectures and Talks)(thanks to Geoffrey Knauth and Hari)Following a mailing-list request, it turns out that there are quite a lot of Scheme-related lectures and talks floating around out there in video format. The following list was compiled by Geoffrey Knauth, with contributions from Hari and Michael Sperber, and at least one insertion from me, right at the front.</p>

<ul>
 <li>
  <p>My sequence of <a href="http://www.youtube.com/playlist?list=PLD0EB7BC8D7CF739A">introductory videos on YouTube</a>, recorded long after this post was made.</p></li>
 <li>
  <p>There&rsquo;s the SICP course Abelson &amp; Sussman gave to [HP, I think] in the mid&ndash;1980s: http://groups.csail.mit.edu/mac/classes/6.001/abelson-sussman-lectures/</p></li>
 <li>
  <p>MIT OCW / 6.001 using SICP, Spring 2005: http://ocw.mit.edu/OcwWeb/Electrical-Engineering-and-Computer-Science/6&ndash;001Spring&ndash;2005/VideoLectures/index.htm</p></li>
 <li>
  <p>All the ICFP 2009 videos (man this made my day!!): http://vidiowiki.com/feature/list/fnu/ICFP_2009</p></li>
 <li>
  <p>Daniel P Friedman - A Celebration (this too!): http://www.cs.indiana.edu/dfried_celebration.html</p></li>
 <li>
  <p>DrScheme v4.0 Tour: http://www.youtube.com/watch?v=vgQO_kHl39g&amp;fmt=18</p></li>
 <li>
  <p>Similar, if you understand Russian:</p></li>
 <li>
  <p>http://www.youtube.com/watch?v=wECY7s9k-V0</p></li>
 <li>
  <p>http://www.youtube.com/watch?v=2CVJjqOT6WM</p></li>
 <li>
  <p>Matthias Felleisen - Programming at Northeastern: http://www.savevid.com/video/matthias-felleisen-programming-at-northeastern-university.html</p></li>
 <li>
  <p>Matthew Flatt - Processes without Partitions: http://www.researchchannel.org/prog/displayevent.aspx?rID=3892</p></li>
 <li>
  <p>Shriram Krishnamurthi on WeScheme: http://vidiowiki.com/watch/cydr9yk/</p></li>
 <li>
  <p>Robby Findler - Macros Matter: http://www.mefeedia.com/video/26348171</p></li>
 <li>
  <p>Using PLT Scheme in the Game Industry: http://www.youtube.com/watch?v=2CVJjqOT6WM</p></li>
 <li>
  <p>Stanford Lecture (Kawa): http://www.youtube.com/watch?v=_cV8NWQCxnE</p></li>
 <li>
  <p>Bluetooth communication using PLT Scheme: http://www.youtube.com/watch?v=pmR_dIXm6sY</p></li>
 <li>SICP at UCB: http://webcast.berkeley.edu/course_details.php?seriesid=1906978454</li>
 <li>
  <p><a href="http://www.aduni.org/courses/sicp/">http://www.aduni.org/courses/sicp/</a> from ADUni by Holly Yanco. It comes with pretty good lecture notes and problem sets.</p></li>
 <li>
  <p>Michael Sperber&rsquo;s DMdA lectures (in German, natch): <a href="http://timms.uni-tuebingen.de/List/List01.aspx?rpattern=UT_200[89]_____00[12]_info1_000_">http://timms.uni-tuebingen.de/List/List01.aspx?rpattern=UT_200[89]_____00[12]<em>info1_000</em></a></p></li></ul></div>
  <a class="more" href='/2010/01/scheme-videos-lectures-and-talks.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>07 Dec 2009</p></col-1>

<col-2>
  <h1><a href='/2009/12/futures-fine-grained-parallelism-in-plt.html'>Futures: Fine Grained Parallelism in PLT</a></h1>
  <div class="truncate">
<p><em>posted by Robby Findler</em></p>

<p>We&rsquo;re pleased to announce the initial release of parallel futures, a construct for fine-grained parallelism in PLT. Roughly speaking, a programmer passes a thunk to &lsquo;future&rsquo; and it gets run in parallel. That &ldquo;roughly&rdquo; holds a few gotchas, partly because we&rsquo;re just getting started and partly due to the technique we&rsquo;re using. See the documentation for more details:</p>

<p><a href="http://pre.plt-scheme.org/docs/html/futures/">http://pre.plt-scheme.org/docs/html/futures/</a></p>

<p>If you&rsquo;ve got a multicore machine where you can&rsquo;t keep the cores busy or your office/machine room is a bit cold, try this program:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="kn">#lang </span><span class="nn">scheme</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">scheme/future</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">loop</span><span class="p">)</span> <span class="p">(</span><span class="n">loop</span><span class="p">))</span>
<span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._for-each))" style="color: inherit">for-each</a></span>
 <span class="nb"><a href="http://docs.racket-lang.org/reference/futures.html#(def._((lib._racket/future..rkt)._touch))" style="color: inherit">touch</a></span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="mi">0</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/futures.html#(def._((lib._racket/future..rkt)._processor-count))" style="color: inherit">processor-count</a></span><span class="p">))])</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/futures.html#(def._((lib._racket/future..rkt)._future))" style="color: inherit">future</a></span> <span class="n">loop</span><span class="p">)))</span>
</pre></div>

</div>

<p>Note that you have to build mzscheme with futures; it isn&rsquo;t enabled by default, but see the docs above for how to do that. Beyond the above, we&rsquo;ve also gotten a few parallel kernels going and are seeing good scalability up to 8 cores (the biggest machine we have around for the time being).</p></div>
  <a class="more" href='/2009/12/futures-fine-grained-parallelism-in-plt.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>01 Dec 2009</p></col-1>

<col-2>
  <h1><a href='/2009/12/plt-scheme-v423.html'>PLT Scheme v4.2.3</a></h1>
  <div class="truncate">
<p><em>posted by Eli Barzilay</em></p>

<p>PLT Scheme version 4.2.3 is now available from <a href="http://plt-scheme.org/"><code>http://plt-scheme.org/</code></a></p>

<ul>
 <li>
  <p>The unit test framework for the teaching languages provides <code>check-member-of</code> and <code>check-range</code> for checking &ldquo;random functions&rdquo;, i.e., &ldquo;functions&rdquo; that may produce several different results for one and the same argument.</p></li>
 <li>
  <p>Added a new image library, <code>2htdp/image</code>. Significant changes from <code>htdp/image</code>:</p></li>
 <li>
  <p>copying and pasting does not introduce jaggies</p></li>
 <li>
  <p><code>equal?</code> comparisons are more efficient</p></li>
 <li>
  <p>added rotation &amp; scaling</p></li>
 <li>
  <p>got rid of pinholes (new overlay, beside, above functions based on bounding boxes)</p></li>
 <li>
  <p>The <code>scheme/vector</code> library provides common vector operations (also reprovided by <code>scheme</code>).</p></li>
 <li>
  <p>The <code>scheme/promise</code> library provides several new kinds of promises with alternatives execution strategies.</p></li>
 <li>
  <p>New port-reading utilities: <code>in-port</code>, <code>port-&gt;list</code>, <code>file-&gt;list</code>.</p></li>
 <li>
  <p>A new require-macro, <code>path-up</code>, for  requiring a file that is higher in the directory tree.</p></li></ul></div>
  <a class="more" href='/2009/12/plt-scheme-v423.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>04 Oct 2009</p></col-1>

<col-2>
  <h1><a href='/2009/10/plt-scheme-v422.html'>PLT Scheme v4.2.2</a></h1>
  <div class="truncate">
<p><em>posted by Eli Barzilay</em></p>

<p>PLT Scheme version 4.2.2 is now available from <a href="http://plt-scheme.org/"><code>http://plt-scheme.org/</code></a></p>

<ul>
 <li>
  <p>DrScheme now, by default, compiles all of the files that are loaded when it runs a program and saves the compiled files in the filesystem. This should lead to faster load times (not faster runtimes) since it avoids re-compiling files whose dependencies have not changed.</p></li>
 <li>
  <p>New Scribble libraries and documentation make it easier to get started with Scribble, especially for uses other than PLT documentation. DrScheme now has better indentation and syntax coloring support for Scribble languages (and generally all @-exp based languages).</p></li>
 <li>
  <p>The new <code>syntax/keyword</code> library provides support for macros with keyword options. A new quick start guide has been added to the documentation for the <code>syntax/parse</code> library.</p></li>
 <li>
  <p>Added support for abstract contracts via the #:exists keywords. This is an experiment to add support for data hiding to the contract system.</p></li>
 <li>
  <p>Added <code>in-producer</code>: a sequence expression makes it easy to iterate over producer functions (e.g., <code>read</code>). A new <code>scheme/generator</code> library creates generators that can use a (parameterized) yield function.</p></li>
 <li>
  <p>HtDP langs: several primitives now consume 0 and 1 arguments in ISL (and up), including <code>append</code>, <code>+</code> and <code>*</code>. In addition, <code>make-list</code> was added to the primitives.</p></li>
 <li>
  <p>The API to Universe has a number of new constructs. All Universe programs should run unchanged. The most important change is the addition of <code>animate</code> as an alternative name for <code>run-simulation</code>. In addition, adding the clause <code>(state true)</code> to a world description now pretty-prints the state of the world into a separate canvas.</p></li>
 <li>
  <p>A number of changes were made to the DeinProgramm / DMdA language levels: The <code>check-property</code> and <code>contract</code> forms were added, <code>define-record-procedures-parametric</code> has changed. See the documentation for details.</p></li>
 <li>
  <p>The test engine in the HtDP languages no longer warns programmers when the Definitions window has no tests.</p></li>
 <li>
  <p>ProfessorJ (and related code) is no longer included in the PLT distributions. It may re-appear in the future as a PLaneT package.</p></li></ul></div>
  <a class="more" href='/2009/10/plt-scheme-v422.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>21 Sep 2009</p></col-1>

<col-2>
  <h1><a href='/2009/09/set-vs-set-box-and-unbox.html'><code>set!</code> vs. <code>set-box!</code> and <code>unbox</code></a></h1>
  <div class="truncate">
<p><em>posted by Robby Findler</em></p>

<p>A few weeks ago I was chatting with some PLT folks and was surprised to hear them say that they avoided <code>set!</code> because using <code>set-box!</code> and <code>unbox</code> was easier to see what was going on.</p>

<p>This struck me as wrong since one might pass boxes around and then you can&rsquo;t be sure which box you&rsquo;re mutating, but you cannot pass variable references around and thus which variable you&rsquo;re using is always lexically apparent. (Of course, when you add <code>lambda</code> into the mix that isn&rsquo;t really true, since you can capture a variable in a closure and pass that around.)</p>

<p>Their point seemed to be that you had to write something special at each use of the box, unlike with <code>set!</code> where you simply write a variable reference and it might be getting a changing quantity and it might not be. This made me realize I could do something to help, at least, and so I changed Check Syntax so that it colored <code>set!</code>&rsquo;d variables in red, like this:</p></div>
  <a class="more" href='/2009/09/set-vs-set-box-and-unbox.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>30 Jul 2009</p></col-1>

<col-2>
  <h1><a href='/2009/07/plt-scheme-v421.html'>PLT Scheme v4.2.1</a></h1>
  <div class="truncate">
<p><em>posted by Eli Barzilay</em></p>

<p>PLT Scheme version 4.2.1 is now available from  <a href="http://plt-scheme.org/"><code>http://plt-scheme.org/</code></a></p>

<ul>
 <li>This is the last release that includes ProfessorJ. As of the next release, Kathy Gray who created and maintained the Professor will move the code to planet and maintain only at a minimal level.</li>
 <li>Typed Scheme 2.0 extends the type system significantly, making it more expressive. For example, predicates applied to selectors, such as (number? (car x)), are meaningful to the type system.</li>
 <li>Faster installation of Planet packages that trigger install of other Planet packages, because the documentation index is updated only once after a group of packages is installed.</li>
 <li>The <code>syntax/parse</code> library provides macro writers with an enhanced syntax pattern matcher that reports errors based on the patterns&rsquo; declared classes of syntax.</li>
 <li>Identifier mappings following the v4 dictionary interface and naming conventions are available from the <code>syntax/id-table</code> library.</li>
 <li>Redex: added <code>define-relation</code> and generalized patterns that appear in &ldquo;where&rdquo; clauses to use the full Redex pattern matcher. (This is a backwards incompatible change, but one often requested; see the Redex release notes for details.)</li>
 <li>The Web Server&rsquo;s serializable closures are now available for other purposes through the web-server/lang/serial-lambda library.</li>
 <li>Teachpacks: small changes to universe portion of the &ldquo;universe.ss&rdquo; API, plus the addition of a form for launching many (communicating) worlds simultaneously. Bug fixes concerning conversion to strings.</li>
 <li>It is now possible to create custom scribble readers with a command characters different than <code>@</code>, see <code>make-at-reader/inside</code> and <code>make-at-reader</code></li>
 <li>Note: this is likely to be the last release that includes a solaris distribution. If you need these builds, or if you have access to a (Sparc) Solaris machine than can be used in PLT builds, then please let me know.</li></ul></div>
  <a class="more" href='/2009/07/plt-scheme-v421.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>23 Jun 2009</p></col-1>

<col-2>
  <h1><a href='/2009/06/serializable-closures-in-plt-scheme.html'>Serializable Closures in PLT Scheme</a></h1>
  <div class="truncate">
<p><em>posted by Jay McCarthy</em></p>

<p>PLT Scheme supports an extensible <a href="http://docs.plt-scheme.org/reference/serialization.html">serialization</a> system for structures. A structure is serializable if it has a <code>prop:serializable</code> property. There are many <a href="http://docs.plt-scheme.org/search/index.html?q=prop%3A">properties</a> in PLT Scheme for other extensions, such as <a href="http://docs.plt-scheme.org/reference/procedures.html#(def._((lib._scheme/base..ss)._prop~3aprocedure))">applicable structures</a> and <a href="http://docs.plt-scheme.org/reference/booleans.html#(def._((quote._~23~25kernel)._prop~3aequal+hash))">custom equality predicates</a>.</p>

<p>The <a href="http://docs.plt-scheme.org/web-server/index.html">PLT Web</a> application development framework uses these features to provide <a href="http://docs.plt-scheme.org/web-server/stateless.html#(part._.Serializable_.Continuations)">serializable continuations</a> through a number of source transformations and a serializable closure structure.</p>

<p><em>Warning: This remainder post refers to features only available in the latest SVN revision of PLT Scheme.</em></p>

<p>I&rsquo;ve recently made these closures more accessible to non-Web programs through <code>web-server/lang/serial-lambda</code>. Here&rsquo;s a demo:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="kn">#lang </span><span class="nn">scheme</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">web-server/lang/serial-lambda</span>
         <span class="n">scheme/serialize</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">f</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">z</span> <span class="mi">5</span><span class="p">])</span>
    <span class="p">(</span><span class="n">serial-lambda</span>
     <span class="p">(</span><span class="n">x</span> <span class="n">y</span><span class="p">)</span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span><span class="p">))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">test-it</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._printf))" style="color: inherit">printf</a></span> <span class="s2">"~S~n"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">fs</span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/serialization.html#(def._((lib._racket/private/serialize..rkt)._serialize))" style="color: inherit">serialize</a></span> <span class="n">f</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._printf))" style="color: inherit">printf</a></span> <span class="s2">"~S~n"</span> <span class="n">fs</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">df</span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/serialization.html#(def._((lib._racket/private/serialize..rkt)._deserialize))" style="color: inherit">deserialize</a></span> <span class="n">fs</span><span class="p">)])</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._printf))" style="color: inherit">printf</a></span> <span class="s2">"~S~n"</span> <span class="n">df</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((quote._~23~25kernel)._printf))" style="color: inherit">printf</a></span> <span class="s2">"~S~n"</span> <span class="p">(</span><span class="n">df</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">)))))</span>

<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">test-it</span><span class="p">)</span>
<span class="mi">8</span>
<span class="p">((</span><span class="mi">2</span><span class="p">)</span> <span class="mi">1</span> <span class="p">((</span><span class="s2">#"/Users/jay/Dev/svn/plt/collects/web-server/exp/test-serial.ss"</span> <span class="o">.</span> <span class="s2">"lifted.6"</span><span class="p">))</span> <span class="mi">0</span> <span class="p">()</span> <span class="p">()</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">5</span><span class="p">))</span>
<span class="o">#</span><span class="p">(</span><span class="ss">struct:7a410aca70b31e88b4c2f0fe77fa7ffe:0</span> <span class="ss">#</span><span class="p">)</span>
<span class="mi">8</span>
</pre></div>

</div>

<p>Now, let&rsquo;s see how it is implemented. <a href="http://svn.plt-scheme.org/plt/trunk/collects/web-server/lang/serial-lambda.ss"><code>web-server/lang/serial-lambda</code></a> is thin wrapper around <a href="http://svn.plt-scheme.org/plt/trunk/collects/web-server/lang/closure.ss"><code>web-server/lang/closure</code></a>, which has two syntax transformer functions: <code>define-closure!</code> which defines the closure structure and <code>make-closure</code> which instantiates the closure. (The two tasks are separated to easily provide a user top-level definition syntax for named closures with different free identifires, rather than simply anonymous lambdas with fixed free identifiers.)</p>

<p><code>make-closure</code> does the following:</p>

<ol>
 <li>
  <p>Expands the procedure syntax using <a href="http://docs.plt-scheme.org/reference/stxtrans.html#(def._((quote._~23~25kernel)._local-expand))"><code>local-expand</code></a>, so it can use <a href="http://docs.plt-scheme.org/syntax/syntax-helpers.html#(def._((lib._syntax/free-vars..ss)._free-vars))"><code>free-vars</code></a> to compute the free identifires.</p></li>
 <li>
  <p>Uses <code>define-closure!</code> to define the structure and get the name for the constructor.</p></li>
 <li>
  <p>Instantiates the closure with the current values of the free identifiers.</p></li></ol>

<p>The more interesting work is done by <code>define-closure!</code>. At a high-level, it needs to do the following:</p>

<ol>
 <li>
  <p>Create a deserialization function.</p></li>
 <li>
  <p>Create a serialization function that references the deserializer.</p></li>
 <li>
  <p>Define the closure structure type that references the serializer.</p></li>
 <li>
  <p>Provide the deserializer from the current module so that arbitrary code can deserialize instances of this closure type.</p></li></ol>

<p>These tasks are complicated in a few ways:</p>

<ul>
 <li>
  <p>The deserializer needs the closure structure type definition to create instances and the serializer needs the closure structure type to access their fields.</p></li>
 <li>
  <p>The serializer needs the syntactic identifier of the deserializer so that <code>scheme/serialize</code> can <a href="http://docs.plt-scheme.org/reference/Module_Names_and_Loading.html#(def._((quote._~23~25kernel)._dynamic-require))"><code>dynamic-require</code></a> it during deserialization.</p></li>
 <li>
  <p>The deserializer must be defined at the top-level, so it may be provided.</p></li>
 <li>
  <p>All this may occur in a syntactic expression context.</p></li></ul>

<p>Thankfully, the PLT Scheme <a href="http://docs.plt-scheme.org/reference/Macros.html">macro system</a> is powerful to support all this.</p>

<ul>
 <li>
  <p><a href="http://docs.plt-scheme.org/reference/stxtrans.html#(def._((quote._~23~25kernel)._syntax-local-lift-expression))"><code>syntax-local-lift-expression</code></a> allows a syntax transformer to lift an expression to the top-level of a module and returns the identifier it is bound to.</p></li>
 <li>
  <p><a href="http://docs.plt-scheme.org/search/index.html?q=syntax-local-lift-values-expression"><code>syntax-local-lift-values-expression</code></a> (added in 4.2.0.3) provides the same for expressions that return multiple values, such as <a href="http://docs.plt-scheme.org/reference/creatingmorestructs.html#(def._((quote._~23~25kernel)._make-struct-type))"><code>make-struct-type</code></a>, which is used to define structures.</p></li>
 <li>
  <p><a href="http://docs.plt-scheme.org/search/index.html?q=syntax-local-lift-provide"><code>syntax-local-lift-provide</code></a> (added in 4.2.0.4) allows a syntax transformer to lift a provide to the top-level.</p></li></ul>

<p>The only complicated piece is allowing the deserializer and serializer to refer to the closure structure constructor and accessors. This is easily accomplished by first defining lifting boxes that will hold these values and initializing them when the structure type is defined. This is safe because all accesses to the boxes are under lambdas that are guaranteed not to be run before the structure type is defined.</p>

<p><strong>An aside on the closure representation.</strong> The closure is represented as a structure with one field: the environment. The environment is represented as a thunk that returns <em>n</em> values, one for each of the free identifiers. This ensures that references that were under lambdas in the original syntax, remain under lambdas in the closure construction, so the serializable closures work correctly inside <code>letrec</code>. This thunk is applied by the serializer and the free values are stored in a vector. The closure also uses the <code>prop:procedure</code> structure property to provide an application function that simply invokes the environment thunk and binds its names, then <code>apply</code>s the original procedure syntax to the arguments.</p>

<p><strong>An aside on the serializer.</strong> The deserializer is bound to lifted identifier which is represented in PLT Scheme as an unreadable symbol. Version 4.2.0.5 added support for (de)serializing these.</p></div>
  <a class="more" href='/2009/06/serializable-closures-in-plt-scheme.html'>more →</a>
<col-2>

</row>

</article>
<footer>
 <ul class="pagination">
  <li><a href="/index-7.html">
    <quote>&larr;</quote></a></li>
  <li><a href="/index.html">1</a></li>
  <li><a href="/index-2.html">2</a></li>
  <li><a href="/index-3.html">3</a></li>
  <li><a href="/index-4.html">4</a></li>
  <li><a href="/index-5.html">5</a></li>
  <li><a href="/index-6.html">6</a></li>
  <li><a href="/index-7.html">7</a></li>
  <li class="active"><a href="/index-8.html">8</a></li>
  <li><a href="/index-9.html">9</a></li>
  <li><a href="/index-10.html">10</a></li>
  <li><a href="/index-11.html">11</a></li>
  <li><a href="/index-12.html">12</a></li>
  <li><a href="/index-13.html">13</a></li>
  <li><a href="/index-14.html">14</a></li>
  <li><a href="/index-9.html">
    <quote>&rarr;</quote></a></li></ul></footer>

<row class="one-column" id="bottom"><col-1></col-1><col-2>
<p>Made with <a href="https://github.com/greghendershott/frog">Frog</a>, a static-blog generator written in Racket.
<br /><a href="https://github.com/racket/racket-lang-org">Source code</a> for this blog.</col-2></row>
  </body>
</html>