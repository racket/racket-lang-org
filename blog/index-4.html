<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>Racket Blog (page 4)</title>
    <meta name="description" content="Racket Blog (page 4)">
    <meta name="author"      content="The Unknown Author">
    <meta name="keywords"    content="all">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="http://blog.racket-lang.org/index-4.html">


    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/blog-fonts.css">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml" href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    </head>
  <body>
<row class="one-column" id="logo"><col-1><a href="http://racket-lang.org"><div id="logo-container"><img id="logo" src="/img/racket-logo.svg"/> Racket</div></a></col-1><col-2><p><a href="/index.html">blog</a></p></col-2></row>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>25 Mar 2013</p></col-1>

<col-2>
  <h1><a href='/2013/03/200.html'>200!</a></h1>
  <div class="truncate">
<p><em>posted by Asumu Takikawa</em></p>

<p>About a month ago, inspired by a mailing list post by Tim Brown, Racketeers started to write more solutions to <a href="http://rosettacode.org/wiki/Rosetta_Code">Rosetta Code</a> tasks for Racket. Just today, we&rsquo;ve reached 200 entries in the <a href="http://rosettacode.org/wiki/Category:Racket">Racket category</a>!</p>

<p>This is a nice milestone, but we still have a ways to go. At 200 entries, Racket comes in at around 54th in the <a href="http://rosettacode.org/wiki/RC_POP.OUT">popularity</a> rankings. So if you&rsquo;re looking to practice your Racketeering skills, don&rsquo;t hesitate to work on some of the <a href="http://rosettacode.org/wiki/Reports:Tasks_not_implemented_in_Racket">remaining tasks</a>.</p>

<p>To give you a taste of the kinds of solutions we have so far, here are some examples.</p>

<p>Mandelbrot:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">iterations</span> <span class="n">a</span> <span class="n">z</span> <span class="n">i</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">z′</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">z</span> <span class="n">z</span><span class="p">)</span> <span class="n">a</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" style="color: inherit">or</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="n">i</span> <span class="mi">255</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._magnitude))" style="color: inherit">magnitude</a></span> <span class="n">z′</span><span class="p">)</span> <span class="mi">2</span><span class="p">))</span>
      <span class="n">i</span>
      <span class="p">(</span><span class="n">iterations</span> <span class="n">a</span> <span class="n">z′</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._add1))" style="color: inherit">add1</a></span> <span class="n">i</span><span class="p">))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">iter-&gt;color</span> <span class="n">i</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="n">i</span> <span class="mi">255</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span> <span class="n">color%</span> <span class="s2">"black"</span><span class="p">)</span>
      <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/objcreation.html#(def._((lib._racket/private/class-internal..rkt)._make-object))" style="color: inherit">make-object</a></span> <span class="n">color%</span> 
        <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mi">5</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._modulo))" style="color: inherit">modulo</a></span> <span class="n">i</span> <span class="mi">15</span><span class="p">))</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mi">32</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._modulo))" style="color: inherit">modulo</a></span> <span class="n">i</span> <span class="mi">7</span><span class="p">))</span> 
          <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mi">8</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._modulo))" style="color: inherit">modulo</a></span> <span class="n">i</span> <span class="mi">31</span><span class="p">)))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">mandelbrot</span> <span class="n">width</span> <span class="n">height</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">target</span> <span class="p">(</span><span class="n">make-screen-bitmap</span> <span class="n">width</span> <span class="n">height</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">dc</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">bitmap-dc%</span> <span class="p">[</span><span class="n">bitmap</span> <span class="n">target</span><span class="p">]))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for*))" style="color: inherit">for*</a></span> <span class="p">([</span><span class="n">x</span> <span class="n">width</span><span class="p">]</span> <span class="p">[</span><span class="n">y</span> <span class="n">height</span><span class="p">])</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">real-x</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mf">3.0</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">x</span> <span class="n">width</span><span class="p">))</span> <span class="mf">2.25</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">real-y</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mf">2.5</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">y</span> <span class="n">height</span><span class="p">))</span> <span class="mf">1.25</span><span class="p">))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">dc</span> <span class="n">set-pen</span> 
      <span class="p">(</span><span class="n">iter-&gt;color</span> 
        <span class="p">(</span><span class="n">iterations</span> 
          <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._make-rectangular))" style="color: inherit">make-rectangular</a></span> <span class="n">real-x</span> <span class="n">real-y</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span> <span class="mi">1</span> <span class="o">'</span><span class="ss">solid</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">dc</span> <span class="n">draw-point</span> <span class="n">x</span> <span class="n">y</span><span class="p">))</span>
  <span class="n">target</span><span class="p">)</span>

<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">mandelbrot300200</span><span class="p">)</span>
</pre></div>

</div>

<p>Yin and Yang:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">yin-yang</span> <span class="n">d</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">base</span>
    <span class="p">(</span><span class="n">hc-append</span> <span class="p">(</span><span class="n">inset/clip</span> <span class="p">(</span><span class="n">circle</span> <span class="n">d</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">0</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">d</span> <span class="mi">2</span><span class="p">))</span> <span class="mi">0</span><span class="p">)</span>
               <span class="p">(</span><span class="n">inset/clip</span> <span class="p">(</span><span class="n">disk</span> <span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">d</span> <span class="mi">2</span><span class="p">))</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">with-top</span>
    <span class="p">(</span><span class="n">ct-superimpose</span>
     <span class="n">base</span>
     <span class="p">(</span><span class="n">cc-superimpose</span> <span class="p">(</span><span class="n">colorize</span> <span class="p">(</span><span class="n">disk</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">d</span> <span class="mi">2</span><span class="p">))</span> <span class="s2">"white"</span><span class="p">)</span>
                     <span class="p">(</span><span class="n">disk</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">d</span> <span class="mi">8</span><span class="p">)))))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">with-bottom</span>
    <span class="p">(</span><span class="n">cb-superimpose</span>
     <span class="n">with-top</span>
     <span class="p">(</span><span class="n">cc-superimpose</span> <span class="p">(</span><span class="n">disk</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">d</span> <span class="mi">2</span><span class="p">))</span>
                     <span class="p">(</span><span class="n">colorize</span> <span class="p">(</span><span class="n">disk</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="n">d</span> <span class="mi">8</span><span class="p">))</span> <span class="s2">"white"</span><span class="p">))))</span>
  <span class="p">(</span><span class="n">cc-superimpose</span> <span class="n">with-bottom</span> <span class="p">(</span><span class="n">circle</span> <span class="n">d</span><span class="p">)))</span>


<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">yin-yang</span> <span class="mi">200</span><span class="p">)</span>
</pre></div>

</div>

<p>Animate a pendulum:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="kn">#lang </span><span class="nn">racket</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._require))" style="color: inherit">require</a></span> <span class="n">2htdp/image</span>
         <span class="n">2htdp/universe</span><span class="p">)</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">pendulum</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">accel</span> <span class="n">θ</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sin))" style="color: inherit">sin</a></span> <span class="n">θ</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">θ</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" style="color: inherit">pi</a></span> <span class="mf">2.5</span><span class="p">))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">θ′</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">θ′′</span> <span class="p">(</span><span class="n">accel</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._/))" style="color: inherit">/</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/math..rkt)._pi))" style="color: inherit">pi</a></span> <span class="mf">2.5</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">x</span> <span class="n">θ</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="mi">200</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mi">150</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sin))" style="color: inherit">sin</a></span> <span class="n">θ</span><span class="p">))))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">y</span> <span class="n">θ</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="mi">150</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._cos))" style="color: inherit">cos</a></span> <span class="n">θ</span><span class="p">)))</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">p-image</span> 
      <span class="p">(</span><span class="n">underlay/xy</span> 
        <span class="p">(</span><span class="n">add-line</span> 
          <span class="p">(</span><span class="n">empty-scene</span> <span class="mi">400</span> <span class="mi">200</span><span class="p">)</span> <span class="mi">200</span> <span class="mi">0</span> <span class="p">(</span><span class="n">x</span> <span class="n">θ</span><span class="p">)</span> <span class="p">(</span><span class="n">y</span> <span class="n">θ</span><span class="p">)</span> <span class="s2">"black"</span><span class="p">)</span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="n">x</span> <span class="n">θ</span><span class="p">)</span> <span class="mi">5</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="p">(</span><span class="n">y</span> <span class="n">θ</span><span class="p">)</span> <span class="mi">5</span><span class="p">)</span> 
              <span class="p">(</span><span class="n">circle</span> <span class="mi">5</span> <span class="s2">"solid"</span> <span class="s2">"blue"</span><span class="p">)))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">θ</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">θ</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">θ′</span> <span class="mf">0.04</span><span class="p">)))</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">θ′</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">θ′</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="p">(</span><span class="n">accel</span> <span class="n">θ</span><span class="p">)</span> <span class="mf">0.04</span><span class="p">)))</span>
    <span class="n">p-image</span><span class="p">))</span>

<span class="p">(</span><span class="n">animate</span> <span class="p">(</span><span class="n">pendulum</span><span class="p">))</span>


<span class="n">Jensen</span><span class="o">'</span><span class="ss">s</span> <span class="n">Device:</span>

<span class="o">```</span><span class="ss">racket</span>
<span class="kn">#lang </span><span class="nn">algol60</span>
<span class="k"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" style="color: inherit">begin</a></span>
   <span class="n">integer</span> <span class="n">i</span><span class="c1">;</span>
   <span class="n">real</span> <span class="n">procedure</span> <span class="n">sum</span> <span class="p">(</span><span class="n">i</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">hi</span><span class="o">,</span> <span class="n">term</span><span class="p">)</span><span class="c1">;</span>
      <span class="n">value</span> <span class="n">lo</span><span class="o">,</span> <span class="n">hi</span><span class="c1">;</span>
      <span class="n">integer</span> <span class="n">i</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">hi</span><span class="c1">;</span>
      <span class="n">real</span> <span class="n">term</span><span class="c1">;</span>
      <span class="n">comment</span> <span class="n">term</span> <span class="n">is</span> <span class="n">passed</span> <span class="n">by-name</span><span class="o">,</span> <span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">so</span> <span class="n">is</span> <span class="n">i</span><span class="c1">;</span>
   <span class="k"><a href="http://docs.racket-lang.org/reference/begin.html#(form._((quote._~23~25kernel)._begin))" style="color: inherit">begin</a></span>
      <span class="n">real</span> <span class="n">temp</span><span class="c1">;</span>
      <span class="n">temp</span> <span class="n">:=</span> <span class="mi">0</span><span class="c1">;</span>
      <span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for))" style="color: inherit">for</a></span> <span class="n">i</span> <span class="n">:=</span> <span class="n">lo</span> <span class="n">step</span> <span class="mi">1</span> <span class="n">until</span> <span class="n">hi</span> <span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/more-scheme..rkt)._do))" style="color: inherit">do</a></span>
         <span class="n">temp</span> <span class="n">:=</span> <span class="n">temp</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">term</span><span class="c1">;</span>
      <span class="n">sum</span> <span class="n">:=</span> <span class="n">temp</span>
   <span class="n">end</span><span class="c1">;</span>
   <span class="n">comment</span> <span class="n">note</span> <span class="n">the</span> <span class="n">correspondence</span> <span class="n">between</span> 
   <span class="n">the</span> <span class="n">mathematical</span> <span class="n">notation</span> <span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="n">the</span> <span class="n">call</span> <span class="n">to</span> <span class="n">sum</span><span class="c1">;</span>
   <span class="n">printnln</span> <span class="p">(</span><span class="n">sum</span> <span class="p">(</span><span class="n">i</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="n">1/i</span><span class="p">))</span>
<span class="n">end</span>
</pre></div>

</div>

<p>Thanks to all of the people who have contributed solutions so far!</p></div>
  <a class="more" href='/2013/03/200.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>15 Feb 2013</p></col-1>

<col-2>
  <h1><a href='/2013/02/racket-v533.html'>Racket v5.3.3</a></h1>
  <div class="truncate">
<p><em>posted by Eli Barzilay</em></p>

<p>Racket version 5.3.3 is now available from <a href="http://racket-lang.org/">http://racket-lang.org/</a></p>

<p>This is a bug-fix release to address a flaw in DrRacket v5.3.2 concerning interactions between the contour window and the syntax coloring.</p></div>
  <a class="more" href='/2013/02/racket-v533.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>31 Jan 2013</p></col-1>

<col-2>
  <h1><a href='/2013/01/racket-v532.html'>Racket v5.3.2</a></h1>
  <div class="truncate">
<p><em>posted by Eli Barzilay</em></p>

<p>Racket version 5.3.2 is now available from <a href="http://racket-lang.org/">http://racket-lang.org/</a> Core Libraries::</p>

<ul>
 <li>
  <p>The new <code>math</code> library provides functions and data structures for working with numbers and collections of numbers. Functions include non-elementary (such as gamma, zeta, Lambert&rsquo;s W), number-theoretic (factorization, modular arithmetic), linear algebra (arithmetic, decompositions), and statistical (expected values, order statistics, binning). Data structures include arbitrary-precision bigfloats, probability distributions, and multidimensional arrays.</p></li>
 <li>
  <p>The new <code>file/untar</code>, <code>file/untgz</code>, and <code>file/unzip</code> libraries support unpacking widely used archive formats.</p></li>
 <li>
  <p>The new <code>lazy-require</code> form allows programs to delay the loading and instantiation of helper modules until they are needed.</p></li>
 <li>
  <p>The new <code>data/bit-vector</code> library provides an implementation of bit vectors (a mutable sequence of booleans) supporting popcount.</p></li>
 <li>
  <p>The <code>racket/generic</code> library allows the specification of default method implementations for core datatypes.</p></li>
 <li>
  <p>The <code>openssl</code> library can verify hostnames and use the operating system&rsquo;s certificate store to verify certificates.</p></li></ul>

<p>Package System::</p>

<ul>
 <li>
  <p>A new package system is in beta release. This system will become Planet&rsquo;s successor. It differs significantly from the latter. For details, please read the documentation at <a href="http://docs.racket-lang.org/planet2/">http://docs.racket-lang.org/planet2/</a> and list your packages on the new index at <a href="https://pkg.racket-lang.org/">https://pkg.racket-lang.org/</a>.</p></li>
 <li>
  <p>The <code>raco test</code> command supports testing by collection and package, in addition to by directory and file, with the <code>-c</code> and <code>-p</code> options.</p></li></ul>

<p>Teaching Libraries::</p>

<ul>
 <li>batch-io: the read and write functions work on Unix-style standard input and output.</li></ul>

<p>DrRacket::</p>

<ul>
 <li>
  <p>DrRacket&rsquo;s GUI is more responsive.</p></li>
 <li>
  <p>The automatic parenthesis insertion mode is improved.</p></li></ul>

<p>Scribble::</p>

<ul>
 <li>
  <p>Scribble renders Markdown format files via the <code>--markdown</code> command-line flag. Example use case: Generate documentation hosted on GitHub or BitBucket.</p></li>
 <li>
  <p>Documentation cross-reference information is stored in an SQLite3 database, which means that SQLite3 is required for building Racket documentation on Unix/Linux machines (but SQLite3 is included in Racket distributions for Windows and Mac OS X).</p></li></ul>

<p> Using a database for cross-reference information significantly reduces the initial footprint of DrRacket, since DrRacket no longer needs to load all cross-reference information.</p>

<p>Typed Racket::</p>

<ul>
 <li>
  <p>Typed Racket programs can require <code>plot/typed</code> to draw plots. List- and vector-accepting functions accept general sequences.</p></li>
 <li>
  <p>Typed Racket supports Racket&rsquo;s delimited continuation and continuation mark operators.</p></li></ul>

<p>Redex::</p>

<ul>
 <li>Added more support for <code>define-judgment-form</code>, including random generation for well-formed judgments and visualization of judgments.</li></ul>

<p>Deprecation::  The following have been removed in this release:</p>

<ul>
 <li>the <code>planet</code> command-line tool; use <code>raco planet</code> instead.</li></ul>

<p>The following has been deprecated and will be removed in the August 2013 release:</p>

<ul>
 <li>the <code>mzlib/class100</code> library; use <code>racket/class</code> instead.</li></ul></div>
  <a class="more" href='/2013/01/racket-v532.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>22 Dec 2012</p></col-1>

<col-2>
  <h1><a href='/2012/12/simple-test-coverage-a-macro-with-line-numbers-and-lifting.html'>Simple Test Coverage: A Macro with Line Numbers and Lifting</a></h1>
  <div class="truncate">
<p><em>posted by Robby Findler</em></p>

<p>Racket&rsquo;s macro system makes it easy to roll your own low-tech line coverage tool. In this post, I&rsquo;ll show how, in 15 lines of code, you can implement a simple test-coverage tool. Using this code is simple: put <code>(line-of-interest)</code> on each line that should be covered.</p>

<p>To start the implementation, we put the code in a module and define two sets:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="kn">#lang </span><span class="nn">racket</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">candidate-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set))" style="color: inherit">set</a></span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">touched-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set))" style="color: inherit">set</a></span><span class="p">))</span>
</pre></div>

</div>

<p>The first set holds the line numbers where <code>(line-of-interest)</code> is written in the source and the second holds the set of line numbers where <code>(line-of-interest)</code> has been executed.</p>

<p>Each use of <code>(line-of-interest)</code> is going to expand into a call to visited with the line number for the source location of that use of <code>(line-of-interest)</code>.</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">visited</span> <span class="n">line</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-member~3f))" style="color: inherit">set-member?</a></span> <span class="n">touched-lines</span> <span class="n">line</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">touched-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-add))" style="color: inherit">set-add</a></span> <span class="n">touched-lines</span> <span class="n">line</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" style="color: inherit">displayln</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._sort))" style="color: inherit">sort</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-~3elist))" style="color: inherit">set-&gt;list</a></span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-subtract))" style="color: inherit">set-subtract</a></span> <span class="n">candidate-lines</span> <span class="n">touched-lines</span><span class="p">))</span>
           <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span><span class="p">))))</span>
</pre></div>

</div>

<p>This function simply checks to see if this line has been executed before and, if not, removes that line number from touched-lines and prints out the current status.</p>

<p>The interesting part of this code is in the definition of line-of-interest itself:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define-syntax))" style="color: inherit">define-syntax</a></span> <span class="p">(</span><span class="n">line-of-interest</span> <span class="n">stx</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._with-syntax))" style="color: inherit">with-syntax</a></span> <span class="p">([</span><span class="n">line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-line))" style="color: inherit">syntax-line</a></span> <span class="n">stx</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxtrans.html#(def._((quote._~23~25kernel)._syntax-local-lift-expression))" style="color: inherit">syntax-local-lift-expression</a></span>
     <span class="o">#'</span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">candidate-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-add))" style="color: inherit">set-add</a></span> <span class="n">candidate-lines</span> <span class="n">line</span><span class="p">)))</span>
    <span class="o">#'</span><span class="p">(</span><span class="n">visited</span> <span class="n">line</span><span class="p">)))</span>
</pre></div>

</div>

<p>The macro first extracts the line number from stx, which gives the source location for the use of <code>(line-of-interest)</code>. This number is then bound to line for use in building later syntax objects. Then the macro calls syntax-local-lift-expression with a syntax object that updates candidate-lines. Expressions passed to syntax-local-lift-expression are lifted to the top-level of the enclosing module making sure that, in this case, each line number is added exactly once without having to execute the code where <code>(line-of-interest)</code> appears. The macro then discards the result of syntax-local-lift-expression and returns a call to the visited function. That&rsquo;s all there is to it!</p>

<p>I originally used this macro to test some changes to DrRacket. I was working on a set of complex GUI interactions and kept losing track of which ones had been tested and which ones hadn&rsquo;t. Here&rsquo;s a simpler program in the same spirit so you can try it out.</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="kn">#lang </span><span class="nn">racket/gui</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">candidate-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set))" style="color: inherit">set</a></span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">touched-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set))" style="color: inherit">set</a></span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">visited</span> <span class="n">line</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/when_unless.html#(form._((lib._racket/private/letstx-scheme..rkt)._unless))" style="color: inherit">unless</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-member~3f))" style="color: inherit">set-member?</a></span> <span class="n">touched-lines</span> <span class="n">line</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">touched-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-add))" style="color: inherit">set-add</a></span> <span class="n">touched-lines</span> <span class="n">line</span><span class="p">))</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/Writing.html#(def._((lib._racket/private/misc..rkt)._displayln))" style="color: inherit">displayln</a></span>
     <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._sort))" style="color: inherit">sort</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-~3elist))" style="color: inherit">set-&gt;list</a></span>
            <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-subtract))" style="color: inherit">set-subtract</a></span> <span class="n">candidate-lines</span> <span class="n">touched-lines</span><span class="p">))</span>
           <span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c))" style="color: inherit">&lt;</a></span><span class="p">))))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define-syntax))" style="color: inherit">define-syntax</a></span> <span class="p">(</span><span class="n">line-of-interest</span> <span class="n">stx</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._with-syntax))" style="color: inherit">with-syntax</a></span> <span class="p">([</span><span class="n">line</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-line))" style="color: inherit">syntax-line</a></span> <span class="n">stx</span><span class="p">)])</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxtrans.html#(def._((quote._~23~25kernel)._syntax-local-lift-expression))" style="color: inherit">syntax-local-lift-expression</a></span>
     <span class="o">#'</span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/set_.html#(form._((quote._~23~25kernel)._set!))" style="color: inherit">set!</a></span> <span class="n">candidate-lines</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sets.html#(def._((lib._racket/set..rkt)._set-add))" style="color: inherit">set-add</a></span> <span class="n">candidate-lines</span> <span class="n">line</span><span class="p">)))</span>
    <span class="o">#'</span><span class="p">(</span><span class="n">visited</span> <span class="n">line</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">f</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">frame%</span> <span class="p">[</span><span class="n">label</span> <span class="s2">""</span><span class="p">]))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">b1</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">button%</span>
                <span class="p">[</span><span class="n">label</span> <span class="s2">"1"</span><span class="p">]</span>
                <span class="p">[</span><span class="n">parent</span> <span class="n">f</span><span class="p">]</span>
                <span class="p">[</span><span class="n">callback</span>
                 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">a</span> <span class="n">b</span><span class="p">)</span>
                   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/private/base..rkt)._random))" style="color: inherit">random</a></span> <span class="mi">3</span><span class="p">)</span>
                     <span class="p">[(</span><span class="mi">0</span><span class="p">)</span>
                      <span class="p">(</span><span class="n">line-of-interest</span><span class="p">)</span>
                      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">b1</span> <span class="n">set-label</span> <span class="s2">"one"</span><span class="p">)]</span>
                     <span class="p">[(</span><span class="mi">1</span><span class="p">)</span>
                      <span class="p">(</span><span class="n">line-of-interest</span><span class="p">)</span>
                      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">b1</span> <span class="n">set-label</span> <span class="s2">"uno"</span><span class="p">)]</span>
                     <span class="p">[(</span><span class="mi">2</span><span class="p">)</span>
                      <span class="p">(</span><span class="n">line-of-interest</span><span class="p">)</span>
                      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">b1</span> <span class="n">set-label</span> <span class="s2">"一"</span><span class="p">)]))]))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">b2</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/objcreation.html#(form._((lib._racket/private/class-internal..rkt)._new))" style="color: inherit">new</a></span> <span class="n">button%</span>
                <span class="p">[</span><span class="n">label</span> <span class="s2">"2"</span><span class="p">]</span>
                <span class="p">[</span><span class="n">parent</span> <span class="n">f</span><span class="p">]</span>
                <span class="p">[</span><span class="n">callback</span>
                 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">a</span> <span class="n">b</span><span class="p">)</span>
                   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/case.html#(form._((lib._racket/private/more-scheme..rkt)._case))" style="color: inherit">case</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((lib._racket/private/base..rkt)._random))" style="color: inherit">random</a></span> <span class="mi">3</span><span class="p">)</span>
                     <span class="p">[(</span><span class="mi">0</span><span class="p">)</span>
                      <span class="p">(</span><span class="n">line-of-interest</span><span class="p">)</span>
                      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">b2</span> <span class="n">set-label</span> <span class="s2">"two"</span><span class="p">)]</span>
                     <span class="p">[(</span><span class="mi">1</span><span class="p">)</span>
                      <span class="p">(</span><span class="n">line-of-interest</span><span class="p">)</span>
                      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">b2</span> <span class="n">set-label</span> <span class="s2">"dos"</span><span class="p">)]</span>
                     <span class="p">[(</span><span class="mi">2</span><span class="p">)</span>
                      <span class="p">(</span><span class="n">line-of-interest</span><span class="p">)</span>
                      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">b2</span> <span class="n">set-label</span> <span class="s2">"二"</span><span class="p">)]))]))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/ivaraccess.html#(form._((lib._racket/private/class-internal..rkt)._send))" style="color: inherit">send</a></span> <span class="n">f</span> <span class="n">show</span> <span class="no">#t</span><span class="p">)</span>
</pre></div>

</div></div>
  <a class="more" href='/2012/12/simple-test-coverage-a-macro-with-line-numbers-and-lifting.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>25 Nov 2012</p></col-1>

<col-2>
  <h1><a href='/2012/11/tutorial-contributing-to-racket.html'>Tutorial: Contributing to Racket</a></h1>
  <div class="truncate">
<p><em>posted by Joe Gibbs Politz</em></p>

<p><em>Originally posted on <a href="http://jpolitz.github.com/blog/2012/11/21/racket-contributing-tutorial.html">jpolitz.github.com</a>.</em></p>

<p>I&rsquo;ve been a longtime user and sometimes fanboy of <a href="http://racket-lang.org/">Racket</a>, but aside from a few bug reports, before this week I hadn&rsquo;t contributed anything back to the language. This week, I started using a little helper macro, which wasn&rsquo;t in the core utils, to make some of my testing easier. I mentioned it to the super-friendly Racket community, they told me they liked it, and my pull request was merged within about 12 hours.</p>

<p>I&rsquo;ve been using Racket for a while, so I knew roughly where to lookto put my code, tests, and documentation. A newer user might not know,so this post outlines, in some detail, the steps I went through to puttogether a tiny feature extension for Racket.</p>

<h2 id="a-tiny-feature">A Tiny Feature</h2>

<p>I&rsquo;m dabbling in the implementation of a <a href="http://github.com/brownplt/pyret-lang">small scripting language called Pyret</a> to study features of scripting objects. The language has a parser, which generates AST nodes. The nodes keep track of their location in the original program for error reporting, unbound identifier reporting, and the like. I wanted to write some test cases for our</p>

<p>parser, which generates things like:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">parse</span> <span class="s2">"o.x"</span><span class="p">)</span>
<span class="p">(</span><span class="n">s-block</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((lib._racket/private/base..rkt)._srcloc))" style="color: inherit">srcloc</a></span> <span class="s2">"parse-tests.rkt"</span> <span class="mi">1</span> <span class="mi">0</span> <span class="no">#f</span> <span class="no">#f</span><span class="p">)</span>
         <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="p">(</span><span class="n">s-dot</span>
                <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((lib._racket/private/base..rkt)._srcloc))" style="color: inherit">srcloc</a></span> <span class="s2">"parse-tests.rkt"</span> <span class="mi">1</span> <span class="mi">0</span> <span class="no">#f</span> <span class="no">#f</span><span class="p">)</span>
                <span class="p">(</span><span class="n">s-id</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/exns.html#(def._((lib._racket/private/base..rkt)._srcloc))" style="color: inherit">srcloc</a></span> <span class="s2">"parse-tests.rkt"</span> <span class="mi">1</span> <span class="mi">0</span> <span class="no">#f</span> <span class="no">#f</span><span class="p">)</span> <span class="o">'</span><span class="ss">o</span><span class="p">)</span>
                <span class="o">'</span><span class="ss">x</span><span class="p">)))</span>
</pre></div>

</div>

<p>A ton of detail is in the output keeping track of line number information. But I don&rsquo;t want to have to type out the line numbers and get them right for each test. I&rsquo;d like to write:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="n">check-match</span> <span class="p">(</span><span class="n">parse</span> <span class="s2">"o.x"</span><span class="p">)</span>
<span class="p">(</span><span class="n">s-block</span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="p">(</span><span class="n">s-dot</span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="p">(</span><span class="n">s-id</span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="o">'</span><span class="ss">o</span><span class="p">)</span> <span class="o">'</span><span class="ss">x</span><span class="p">))))</span>
</pre></div>

</div>

<p>Which checks that all the things I care about for the parse are true: the program parses to a block of code, with a single statement, which is a dot expression of the identifier <code>o</code> and the symbol <code>x</code>. With a little help from <a href="http://www.jonahkagan.me/">Jonah Kagan</a>, I produced a macro that does exactly that, and works nicely with <a href="http://docs.racket-lang.org/rackunit/api.html">RackUnit</a>, Racket&rsquo;s unit-testing framework (<a href="https://github.com/brownplt/pyret-lang/blob/master/src/tests/parse-tests.rkt#L36">see it in action</a>, with a slightly different name).</p>

<p>I thought <code>check-match</code> was pretty useful, and figured I&rsquo;d see if the Racket folks at large would agree. I <a href="http://www.mail-archive.com/dev@racket-lang.org/msg07427.html">wrote a message</a> to the Racket mailing list, figuring someone might think it was neat. There was some <a href="http://www.mail-archive.com/dev@racket-lang.org/msg07429.html">immediate</a> <a href="http://www.mail-archive.com/dev@racket-lang.org/msg07430.html">positive</a> <a href="http://www.mail-archive.com/dev@racket-lang.org/msg07428.html">feedback</a>, so I decided to go ahead and try to add it.</p>

<p>Getting and Extending Racket &mdash;</p>

<p><a href="http://github.com/plt/racket">Racket&rsquo;s repo</a> is hosted on Github. The easiest way to contribute is to <a href="https://help.github.com/articles/fork-a-repo">fork it</a>, and then check out your own copy. The check-out and build process is fairly standard; you should, however, make a directory called <code>build/</code> to hold the binaries that will be created:</p>

<div class="brush: bash">
 <div class="pygments">
  <pre><span class="nv">$ </span>git clone git://github.com/&lt;your-username&gt;/racket.git
<span class="nv">$ </span><span class="nb">cd </span>racket/src
<span class="nv">$ </span>mkdir build
<span class="nv">$ </span><span class="nb">cd </span>build
<span class="nv">$ </span>../configure
<span class="nv">$ </span>make
<span class="nv">$ </span>make install
</pre></div>

</div>

<p>This takes about 20&ndash;30 minutes, and installs all the necessary Racket binaries locally in place (no <code>sudo</code> or anything needed).</p>

<p>Next up was to find RackUnit and the code I&rsquo;d need to extend.</p>

<p>Most of what goes on in Racket&rsquo;s core utilities happens in <em>collections</em>, found in the <code>collects/</code> directory of the base directory of the checkout. For my implementation, I&rsquo;d be looking at <code>collects/rackunit</code>.</p>

<p>I want to implement a new kind of <code>check</code>, so let&rsquo;s find that in RackUnit. Here&rsquo;s what the RackUnit directory looks like:</p>

<div class="brush: bash">
 <div class="pygments">
  <pre><span class="nv">$ </span>ls collects/rackunit/
compiled           gui.rkt   main.rkt  scribblings  tool.rkt
docs-complete.rkt  info.rkt  private   text-ui.rkt
</pre></div>

</div>

<p>The <code>private/</code> directory contains most of the internals of the built-in collections&rsquo; behavior, so let&rsquo;s look at that:</p>

<div class="brush: bash">
 <div class="pygments">
  <pre><span class="nv">$ </span>ls collects/rackunit/private/
base.rkt        counter.rkt     location.rkt        <span class="nb">test</span>-case.rkt
check-info.rkt  format.rkt      monad.rkt           test.rkt
check.rkt       gui             name-collector.rkt  <span class="nb">test</span>-suite.rkt
compiled        <span class="nb">hash</span>-monad.rkt  result.rkt          text-ui-util.rkt
</pre></div>

</div>

<p>Well, <code>check.rkt</code> seems awfully promising. It defines all of the checks that you can see in the RackUnit docs:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/require.html#(form._((lib._racket/private/base..rkt)._provide))" style="color: inherit">provide</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span>
         <span class="n">check-eq?</span>
         <span class="n">check-eqv?</span>
         <span class="n">check-equal?</span>
         <span class="n">check-=</span>
         <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span><span class="p">)</span>

<span class="p">(</span><span class="n">define-binary-check</span> <span class="p">(</span><span class="n">check-eq?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._eq~3f))" style="color: inherit">eq?</a></span> <span class="n">expr1</span> <span class="n">expr2</span><span class="p">))</span>

<span class="p">(</span><span class="n">define-binary-check</span> <span class="p">(</span><span class="n">check-eqv?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._eqv~3f))" style="color: inherit">eqv?</a></span> <span class="n">expr1</span> <span class="n">expr2</span><span class="p">))</span>

<span class="p">(</span><span class="n">define-binary-check</span> <span class="p">(</span><span class="n">check-equal?</span> <span class="n">expr1</span> <span class="n">expr2</span><span class="p">)</span>
  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._equal~3f))" style="color: inherit">equal?</a></span> <span class="n">expr1</span> <span class="n">expr2</span><span class="p">))</span>

<span class="p">(</span><span class="n">define-simple-check</span> <span class="p">(</span><span class="n">check-=</span> <span class="n">expr1</span> <span class="n">expr2</span> <span class="n">epsilon</span><span class="p">)</span>
  <span class="p">(</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._magnitude))" style="color: inherit">magnitude</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">expr1</span> <span class="n">expr2</span><span class="p">))</span> <span class="n">epsilon</span><span class="p">))</span>

<span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span>
</pre></div>

</div>

<p>But before I go sticking my code in there willy-nilly, it&rsquo;s important to realize there are three things that need to go with a commit like this:</p>

<ul>
 <li>
  <p>Tests</p></li>
 <li>
  <p>Implementation</p></li>
 <li>
  <p>Documentation</p></li></ul>

<p>We&rsquo;ll build up our commit in those stages.</p>

<h2 id="adding-tests">Adding Tests</h2>

<p>First, I need to know how I&rsquo;m going to test this to make sure I don&rsquo;t screw anything up with my edits. There&rsquo;s actually a whole collection for tests in <code>collects/tests/</code>, which includes a rackunit subdirectory. Conveniently, this has been further divided into files that correspond to the files from the RackUnit collection itself:</p>

<div class="brush: bash">
 <div class="pygments">
  <pre><span class="nv">$ </span>ls collects/tests/rackunit/
all-rackunit-tests.rkt  monad-test.rkt                
base-test.rkt           pr10950.rkt                   
check-info-test.rkt     result-test.rkt               
check-test.rkt          run-tests.rkt                 
counter-test.rkt        standalone-check-test.rkt     
format-test.rkt         standalone.rkt                
<span class="nb">hash</span>-monad-test.rkt     standalone-test-case-test.rkt
location-test.rkt       <span class="nb">test</span>-case-test.rkt
</pre></div>

</div>

<p>So, we can add a few expected uses to <code>check-test.rkt</code>, which will be tested against the implementation. I found the end of the check-tests, and inserted some simple test cases there, using the existing style of the file:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" style="color: inherit">...</a></span>
   <span class="c1">;; existing tests</span>
   <span class="p">(</span><span class="n">test-case</span> <span class="s2">"Use of check as expression"</span>
              <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._for-each))" style="color: inherit">for-each</a></span> <span class="n">check-false</span> <span class="o">'</span><span class="p">(</span><span class="no">#f</span> <span class="no">#f</span> <span class="no">#f</span><span class="p">)))</span>
   <span class="p">(</span><span class="n">test-case</span> <span class="s2">"Use of <a href="http://docs.racket-lang.org/reference/local.html#(form._((lib._racket/local..rkt)._local))" style="color: inherit">local</a> check as expression"</span>
              <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">()</span>
                <span class="p">(</span><span class="n">define-simple-check</span> <span class="p">(</span><span class="n">check-symbol?</span> <span class="n">x</span><span class="p">)</span>
                  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span> <span class="n">x</span><span class="p">))</span>
                <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/map..rkt)._for-each))" style="color: inherit">for-each</a></span> <span class="n">check-symbol?</span> <span class="o">'</span><span class="p">(</span><span class="ss">a</span> <span class="ss">b</span> <span class="ss">c</span><span class="p">))))</span>
   <span class="c1">;; my added tests</span>
   <span class="p">(</span><span class="n">test-case</span> <span class="s2">"Trivial check-match test"</span>
              <span class="p">(</span><span class="n">check-match</span> <span class="s2">"dirigible"</span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span><span class="p">))</span>

   <span class="p">(</span><span class="n">test-case</span> <span class="s2">"Simple check-match test"</span>
              <span class="p">(</span><span class="n">check-match</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="mi">3</span><span class="p">)))</span>

   <span class="p">(</span><span class="n">test-case</span> <span class="s2">"check-match with a nested struct"</span>
              <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">()</span>
                <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span> <span class="n">data</span> <span class="p">(</span><span class="n">f1</span> <span class="n">f2</span> <span class="n">f3</span><span class="p">))</span>
                <span class="p">(</span><span class="n">check-match</span> <span class="p">(</span><span class="n">data</span> <span class="mi">1</span> <span class="mi">2</span> <span class="p">(</span><span class="n">data</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
                             <span class="p">(</span><span class="n">data</span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="mi">2</span> <span class="p">(</span><span class="n">data</span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span><span class="p">)))))</span>
</pre></div>

</div>

<h2 id="implementation-and-running-tests">Implementation and Running Tests</h2>

<p>With the tests written, it&rsquo;s safe to go back and add my implementation to <code>check.rkt</code>, since I&rsquo;ll know if I&rsquo;ve succeeded or not via these tests. I added my implementation there, with some comment caveats about how <code>check-match</code> differs from other checks:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="c1">;; NOTE(jpolitz): This match form isn&#39;t eager like the others, hence</span>
<span class="c1">;; the define-syntax and the need to carry around location information</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define-syntax))" style="color: inherit">define-syntax</a></span> <span class="p">(</span><span class="n">check-match</span> <span class="n">stx</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._syntax-case))" style="color: inherit">syntax-case</a></span> <span class="n">stx</span> <span class="p">()</span>
   <span class="p">((</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="n">actual</span> <span class="n">expected</span> <span class="n"><a href="http://docs.racket-lang.org/ts-reference/Legacy_Forms.html#(form._((lib._typed-racket/base-env/base-types-extra..rkt)._pred))" style="color: inherit">pred</a></span><span class="p">)</span>
     <span class="c1">;;... implementation here ...</span>
   <span class="p">)))</span>
</pre></div>

</div>

<p>The actual implementation of <code>check-match</code> is turns the pieces into an instance of <code>match</code> that yields true or false depending on if the value was matched. Here&rsquo;s the essence:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define-syntax))" style="color: inherit">define-syntax</a></span> <span class="n">check-match</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._syntax-rules))" style="color: inherit">syntax-rules</a></span> <span class="p">()</span>
    <span class="p">[(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="n">actual</span> <span class="n">expected</span> <span class="n"><a href="http://docs.racket-lang.org/ts-reference/Legacy_Forms.html#(form._((lib._typed-racket/base-env/base-types-extra..rkt)._pred))" style="color: inherit">pred</a></span><span class="p">)</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">actual-val</span> <span class="n">actual</span><span class="p">])</span>
      <span class="p">(</span><span class="n">check-true</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">actual-val</span>
                   <span class="p">[</span><span class="n">expected</span> <span class="n"><a href="http://docs.racket-lang.org/ts-reference/Legacy_Forms.html#(form._((lib._typed-racket/base-env/base-types-extra..rkt)._pred))" style="color: inherit">pred</a></span><span class="p">]</span>
                   <span class="p">[</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="no">#f</span><span class="p">])))))]</span>
    <span class="p">[(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="n">actual</span> <span class="n">expected</span><span class="p">)</span>
     <span class="p">(</span><span class="n">check-match</span> <span class="n">actual</span> <span class="n">expected</span> <span class="no">#t</span><span class="p">)]</span><span class="err">))</span>
</pre></div>

</div>

<p>In reality, this gives lousy error reporting, so the <a href="https://github.com/plt/racket/blob/e264e4148884f0675bd21e889525ccb7239eb4b4/collects/rackunit/private/check.rkt#L286">actual implementation</a> leverages the helpful <a href="http://docs.racket-lang.org/rackunit/api.html#(form._((lib._rackunit/main..rkt)._with-check-info))">with-check-info</a> form to populate the test with reporting information for failures.</p>

<p>With the implementation in place, it&rsquo;s time to run the tests, and figure out if what I did broke anything. To run a particular test suite, Racket provides a tool called <code>raco</code> that was built by the <code>make install</code> above. To run our tests, we do (from the base <code>racket/</code> directory):</p>

<div class="brush: bash">
 <div class="pygments">
  <pre><span class="nv">$ </span>./bin/raco <span class="nb">test </span>collects/tests/rackunit
</pre></div>

</div>

<p>I iterated through this a few times to suss out all the minor bugs in what I&rsquo;d written. I also wanted to check that my tests were actually adding to the count, so I compared to the version without my changes by doing:</p>

<div class="brush: bash">
 <div class="pygments">
  <pre><span class="nv">$ </span>git stash
<span class="c"># stores my edits temporarily in git&#39;s stash</span>
<span class="nv">$ </span>./bin/raco <span class="nb">test </span>collects/tests/rackunit
<span class="c"># Output including "120 tests passed, 0 tests failed"</span>
<span class="nv">$ </span>git stash apply
<span class="c"># re-applies my edits</span>
<span class="nv">$ </span>./bin/raco <span class="nb">test </span>collects/tests/rackunit
<span class="c"># Output including "127 tests passed, 0 tests failed", which seems good,</span>
<span class="c"># since I wrote 7 new tests</span>
</pre></div>

</div>

<p>So, I&rsquo;m happy with my implementation. All that&rsquo;s left is to write something down about this feature that others will be able to find it and use it in the future.</p>

<h2 id="adding-documentation">Adding Documentation</h2>

<p>Racket uses a tool called <a href="http://docs.racket-lang.org/scribble/index.html">Scribble</a> for documentation, and by convention, a collection&rsquo;s documentation is stored in the <code>scribblings/</code> subdirectory of the collection:</p>

<div class="brush: bash">
 <div class="pygments">
  <pre><span class="nv">$ </span>ls collects/rackunit/scribblings/
acknowledgements.scrbl  control-flow.scrbl  philosophy.scrbl
api.scrbl               file.rkt            quick-start.scrbl
base.rkt                file-test.rkt       rackunit.scrbl
check.scrbl             internals.scrbl     release-notes.scrbl
compiled                misc.scrbl          ui.scrbl
compound-testing.scrbl  overview.scrbl      utils.scrbl
</pre></div>

</div>

<p>Keeping with the theme, we&rsquo;ll be editing <code>check.scrbl</code> which is the file that&rsquo;s used to generate <a href="http://docs.racket-lang.org/rackunit/api.html#(part._.Checks)">this section</a> of the RackUnit documentation.</p>

<p>Reading over the existing docs, I notice that our new feature is violating one of the principles of the existing documentation:</p>

<blockquote>
 <p>Although checks are implemented as macros, which is necessary to grab source location, they are conceptually functions. This means, for instance, checks always evaluate their arguments.</p></blockquote>

<p>Based on <a href="http://www.mail-archive.com/dev@racket-lang.org/msg07435.html">Robby&rsquo;s recommendation</a> (the mailing list is helpful and responsive again!) I simply added a caveat "(with the exception of @racket[check-match] below)", and moved on to adding actual documentation for <code>check-match</code>.</p>

<p>Scribble does two very cool things when documenting definitions. First, it has explicit syntax for telling the documentation system that you&rsquo;re introducing a new identifier that should be indexed and linkable. Second, it lets you write Racket code examples directly into the documentation, and even runs them and renders their results inline into the documenation. Here&rsquo;s a snippet of what I add:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="n">@defform*</span><span class="p">[((</span><span class="n">check-match</span> <span class="n">v</span> <span class="n"><a href="http://docs.racket-lang.org/syntax/stxparse-specifying.html#(form._((lib._syntax/parse..rkt)._pattern))" style="color: inherit">pattern</a></span><span class="p">)</span>
           <span class="p">(</span><span class="n">check-match</span> <span class="n">v</span> <span class="n"><a href="http://docs.racket-lang.org/syntax/stxparse-specifying.html#(form._((lib._syntax/parse..rkt)._pattern))" style="color: inherit">pattern</a></span> <span class="n"><a href="http://docs.racket-lang.org/ts-reference/Legacy_Forms.html#(form._((lib._typed-racket/base-env/base-types-extra..rkt)._pred))" style="color: inherit">pred</a></span><span class="p">))]{</span>

<span class="n">A</span> <span class="n">check</span> <span class="n">that</span> <span class="n"><a href="http://docs.racket-lang.org/syntax/stxparse-specifying.html#(form._((lib._syntax/parse..rkt)._pattern))" style="color: inherit">pattern</a></span> <span class="n">matches</span> <span class="n">on</span> <span class="n">the</span> <span class="n">test</span> <span class="n">value.</span>  <span class="n">Matches</span> <span class="n">the</span> <span class="n">test</span> <span class="n">value</span>
<span class="n">@racket</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="n">against</span> <span class="n">@racket</span><span class="p">[</span><span class="n"><a href="http://docs.racket-lang.org/syntax/stxparse-specifying.html#(form._((lib._syntax/parse..rkt)._pattern))" style="color: inherit">pattern</a></span><span class="p">]</span> <span class="n">as</span> <span class="n">a</span> <span class="n">@racket</span><span class="p">[</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span><span class="p">]</span> <span class="n">clause.</span>  <span class="n">If</span> <span class="n">no</span>
<span class="n">@racket</span><span class="p">[</span><span class="n"><a href="http://docs.racket-lang.org/ts-reference/Legacy_Forms.html#(form._((lib._typed-racket/base-env/base-types-extra..rkt)._pred))" style="color: inherit">pred</a></span><span class="p">]</span> <span class="n">is</span> <span class="n">provided</span><span class="o">,</span> <span class="n">then</span> <span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="n">the</span> <span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">succeeds</span><span class="o">,</span> <span class="n">the</span> <span class="n">entire</span> <span class="n">check</span>
<span class="n">succeeds.</span>  <span class="n">For</span> <span class="n">example</span><span class="o">,</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">use</span> <span class="n">succeeds:</span>

<span class="n">@interaction</span><span class="p">[</span><span class="kd">#:eval</span> <span class="n">rackunit-eval</span>
  <span class="p">(</span><span class="n">check-match</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="mi">3</span><span class="p">))</span>
<span class="p">]</span>

<span class="n">This</span> <span class="n">check</span> <span class="n">fails</span> <span class="n">to</span> <span class="n">match:</span>

<span class="n">@interaction</span><span class="p">[</span><span class="kd">#:eval</span> <span class="n">rackunit-eval</span>
  <span class="p">(</span><span class="n">check-match</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list))" style="color: inherit">list</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="mi">4</span><span class="p">))</span>
<span class="p">]</span>
</pre></div>

</div>

<p>There are a few things going on here:</p>

<ul>
 <li>
  <p><code>@defform</code> tells Scribble that this is a new syntactic form that should be indexed. Scribble figures out the the name is <code>check-match</code>, and adds links for it to the table of contents and enters it in the search index.</p></li>
 <li>
  <p><code>@racket[v]</code> tells Scribble to render <code>v</code> as Racket code, and Scribble is also smart enough to know that <code>v</code> is the same <code>v</code> in the definition, and creates a back link for it.</p></li>
 <li>
  <p><code>@interaction[#:eval rackunit-eval ... ]</code> blocks indicate expressions that should be run, with their output rendered after them. This makes for beautiful docs with examples inline to show users exactly what their getting. To build the docs, we run:</p></li></ul>

<div class="brush: bash">
 <div class="pygments">
  <pre><span class="nv">$ </span>./bin/raco setup collects/rackunit
</pre></div>

</div>

<p>Then, the docs will appear in the local documentation directory. I can then open them up in a web browser and see the results (note the local url ending api.html; that&rsquo;s the local path to the documentation that&rsquo;s been installed):</p>

<p>Looks good!</p>

<h2 id="letting-racketeers-know">Letting Racketeers Know</h2>

<p>I packaged everything up in a <a href="https://github.com/jpolitz/racket/commit/023d2278c1bb9819451790d774ae8e67a5d46f22">single commit</a>, and sent the whole thing off to the Racket folks with a <a href="https://github.com/plt/racket/pull/171">pull request</a>. They then reviewed it and incorporated it into <a href="https://github.com/plt/racket/commit/e264e4148884f0675bd21e889525ccb7239eb4b4">their HEAD</a> the next day.</p>

<p>The Racket folks maintain a list of <a href="https://github.com/plt/racket/wiki/Intro-Projects">Intro Projects</a>, so there&rsquo;s easy places to start if you want to follow this tutorial and get involved!</p></div>
  <a class="more" href='/2012/11/tutorial-contributing-to-racket.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>23 Nov 2012</p></col-1>

<col-2>
  <h1><a href='/2012/11/roman-numerals-in-racket-sources.html'>Roman Numerals in Racket Sources</a></h1>
  <div class="truncate">
<p><em>posted by Shriram Krishnamurthi</em></p>

<p>The other day, while discussing Church numerals in class, I pointed out that Racket could support Roman numeral in source programs. The essence of the idea is that, whenever an unbound identifier matches the syntax of a Roman numeral, it is automatically converted into the corresponding number.</p>

<p>The implementation of this is <a href="https://github.com/shriram/roman-numerals">here</a>. The <a href="https://github.com/shriram/roman-numerals/blob/master/test-client.rkt">test client</a> best illustrates this in action. For instance, here is a valid test case:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">square</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">x</span> <span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">check-equal?</span> <span class="p">(</span><span class="n">square</span> <span class="n">X</span><span class="p">)</span> <span class="n">C</span><span class="p">)</span>
</pre></div>

</div>

<p>The essence of the implementation is just this macro:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define-syntax))" style="color: inherit">define-syntax</a></span> <span class="p">(</span><span class="n">handle-id</span> <span class="n">stx</span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._syntax-case))" style="color: inherit">syntax-case</a></span> <span class="n">stx</span> <span class="p">()</span>
    <span class="p">[(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="o">.</span> <span class="k"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(form._((lib._racket/contract/private/misc..rkt)._any))" style="color: inherit">any</a></span><span class="p">)</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">str</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol-~3estring))" style="color: inherit">symbol-&gt;string</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._syntax-~3edatum))" style="color: inherit">syntax-&gt;datum</a></span> <span class="o">#'</span><span class="k"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(form._((lib._racket/contract/private/misc..rkt)._any))" style="color: inherit">any</a></span><span class="p">))])</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="n">roman-string?</span> <span class="n">str</span><span class="p">)</span>
           <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._with-syntax))" style="color: inherit">with-syntax</a></span> <span class="p">[(</span><span class="n">n</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/stxops.html#(def._((quote._~23~25kernel)._datum-~3esyntax))" style="color: inherit">datum-&gt;syntax</a></span> <span class="n">stx</span> <span class="p">(</span><span class="n">roman-&gt;number</span> <span class="n">str</span><span class="p">)))]</span>
             <span class="o">#'</span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/quote.html#(form._((quote._~23~25kernel)._~23~25datum))" style="color: inherit">#%datum</a></span> <span class="o">.</span> <span class="n">n</span><span class="p">))</span>
           <span class="o">#'</span><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/__top.html#(form._((quote._~23~25kernel)._~23~25top))" style="color: inherit">#%top</a></span> <span class="o">.</span> <span class="k"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(form._((lib._racket/contract/private/misc..rkt)._any))" style="color: inherit">any</a></span><span class="p">)))]))</span>
</pre></div>

</div></div>
  <a class="more" href='/2012/11/roman-numerals-in-racket-sources.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>15 Nov 2012</p></col-1>

<col-2>
  <h1><a href='/2012/11/drracket-now-more-responsive.html'>DrRacket, now more responsive</a></h1>
  <div class="truncate">
<p><em>posted by Robby Findler</em></p>

<p>DrRacket is now more responsive when editing than the 5.3.1 release. How much more? Well, I ran a script that starts up DrRacket, opens class-internal.rkt from the distribution and puts the insertion point right before the first " character. It then repeats these three steps 10 times: first it types fdjafjdklafjkdalsfjdaklfjdkaslfdjafjdklafjkdalsfjdaklfjdkasl as fast as it can, then it types the same number of backspaces. Next it type "a and waits for the syntax colorer to finish adjusting the colors. Then it deletes those two (again with two backspaces) finally waits for background check syntax to complete.</p>

<p>The script also measures the number of wall-clock milliseconds that the handling of each event took and here are the results:</p>

<p>Each vertical bar’s hight is proportional to the percentage of the events that took at least the corresponding number of milliseconds. The red bars show how well version 5.3.1’s DrRacket does, and the blue shows how the current git head fares (as of <a href="http://git.racket-lang.org/plt/commit/a4d440a5">http://git.racket-lang.org/plt/commit/a4d440a5</a>).</p>

<p>As you can see, about 80% of the events took less than 26 milliseconds to complete in the current version, but more like 60 milliseconds in 5.3.1. As some sense of scale, a television refreshes its screen every 16 2/3s millseconds, so if all of the events took less than that then DrRacket would feel very responsive indeed.</p>

<p>How?:  The key to finding all of the performance improvements was finding something to measure. It sounds simple (and indeed, it didn’t take long to do), but once I had that, it because relatively easy to find suspiciously slow events, to sort out what they were doing and to speed them up. (Thanks to <a href="http://www.cs.utah.edu/~mflatt/">Matthew</a> for this excellent advice!)</p>

<p>Specifically, I added a bunch of logging to various parts of racket/gui, framework, and DrRacket itself. For example, the graphs above are generated from logging information about how long events take to be handled.</p>

<p>Some of the problems were stupid things, e.g., <a href="http://git.racket-lang.org/plt/commit/4421e227ffa">there was one place</a> where DrRacket was overriding a callback that happened on each keystroke that would invalidate the entire visible region of the editor. This forced the entire buffer to be redrawn on each keystroke, making DrRacket’s sluggishness proportional to the size of the definitions window(!).</p>

<p>The performance graph above was recorded a smallish window, namely maximzed on my laptop: 1365x740. A bigger window doesn’t change the blue bars, but here’s how a 1102x1174 changes the red ones:</p>

<p>There were two more complex fixes. First: background check syntax. It runs mostly in a separate, parallel place and thus (on a multi-core machine) doesn’t interfere with DrRacket’s editing all. The last phase, however, is to communicate the results of check syntax back and that has to update state on the GUI and thus competes with the handling of callbacks. This communication breaks up the check syntax information into chunks and installs that information one chunk at a time, so as to avoid tying up the event handling thread for too long. Thanks to some logging, I found that some of the chunks were too large and was able to split them up into smaller chunks.</p>

<p>The most complex change was in the syntax colorer. It used to use a co-routine that would parse part of the buffer, suspend the co-routine, color the part it parsed, and then yield control back to handle other events. Unfortunately, the coroutine would commonly run for 10 or 15 milliseconds, but then build up 30 or 40 milliseconds worth of work to do to color the buffer. The fix to the colorer was to eliminate the co-routine and interleave the coloring and the parsing, meaning the whole process now has finer granularity, and thus is able to be interrupted more frequently and more accurately.</p>

<p>Not done yet:  There is still a lot more to do. Editing scribble files is less responsive and the contour window definitely still makes DrRacket sluggish. Yesterday I was able to get DrRacket in a state that brought back some sluggishness and I don’t know how I did that (restarting DrRacket got rid of the problem, unfortunately). I also think I need to look more closely and what happens when purple search bubbles are visible. An interactive GC would probably also help.</p>

<p>If you spot some way to make DrRacket feel more sluggish than it should be, please let me know!</p></div>
  <a class="more" href='/2012/11/drracket-now-more-responsive.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>07 Nov 2012</p></col-1>

<col-2>
  <h1><a href='/2012/11/racket-v531.html'>Racket v5.3.1</a></h1>
  <div class="truncate">
<p><em>posted by Eli Barzilay</em></p>

<p>Racket version 5.3.1 is now available from <a href="http://racket-lang.org/">http://racket-lang.org/</a> Racket::</p>

<ul>
 <li>
  <p>The <code>case</code> form dispatches on characters, fixnums, symbols, and keywords in logarithmic time. (Thanks to Jon Zeppieri.)</p></li>
 <li>
  <p>The new <code>racket/format</code> library provides new and improved string-formatting functions.</p></li>
 <li>
  <p>Logging tools include improved filtering support based on the name of a logger. A new <code>define-logger</code> form simplifies the use of named loggers. Forms such as <code>log-debug</code> now support string formatting.</p></li>
 <li>
  <p>The <code>for</code> forms now support <code>#:break</code> and <code>#:final</code> clauses.</p></li>
 <li>
  <p>The new <code>PLTCOMPILEDROOTS</code> environment variable configures the search path for compiled bytecode.</p></li></ul>

<p>DrRacket::</p>

<ul>
 <li>
  <p>Check Syntax now summarizes the documentation (i.e., the blue boxes) for the identifier at the insertion point in the top-right corner of the definitions window.</p></li>
 <li>
  <p>Check Syntax now runs continuously for programs that declare their language within the source. This mode has been available for several of the past releases, but now enabled by default.</p></li>
 <li>
  <p>DrRacket can spell-check string constants (enable this in the Edit menu).</p></li></ul>

<p>Typed Racket::</p>

<ul>
 <li>
  <p>Typed Racket interprets the <code>Any</code> type as a different contract. This may signal dynamic errors in some existing mixed typed/untyped programs. The normal fix is to replace a use of <code>Any</code> with a more specific types.</p></li>
 <li>
  <p>NaN is included in all of Typed Racket&rsquo;s floating-point types, which makes precise floating-point types easier to use.</p></li>
 <li>
  <p>Typed Racket supports a <code>cast</code> operation with support for higher-order types.</p></li>
 <li>
  <p>Typed Racket provides the <code>:query-type/args</code> and <code>:query-type/result</code> utilities to explore types at the REPL.</p></li></ul>

<p>Miscellaneous::</p>

<ul>
 <li>
  <p>The <code>compatibility</code> collection provides features from Racket relatives, such as <code>defmacro</code> and mutable lists. These features are provided to ease porting code to Racket. Avoid them in modern Racket code.</p></li>
 <li>
  <p>Screenshots of the widgets provided by the Racket GUI library are included in the documentation. (Thanks to Diogo F. S. Ramos.)</p></li>
 <li>
  <p>FrTime was ported to racket <code>#lang</code>. (Thanks to Patrick Mahoney.)</p></li></ul>

<p>Deprecation::  The following has been deprecated and will be removed in the January 2013 release:</p>

<ul>
 <li>the <code>planet</code> command-line tool; use <code>raco planet</code> instead.</li></ul>

<p>The following has been deprecated and will be removed in the August 2013 release:</p>

<ul>
 <li>the <code>mzlib/class100</code> library; use <code>racket/class</code> instead.</li></ul></div>
  <a class="more" href='/2012/11/racket-v531.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>01 Nov 2012</p></col-1>

<col-2>
  <h1><a href='/2012/11/generics.html'>Generics</a></h1>
  <div class="truncate">
<p><em>posted by Asumu Takikawa</em></p>

<p>Recently at <a href="http://con.racket-lang.org/">RacketCon</a>, I gave a talk about the new Generics library that ships with Racket 5.3. In this blog post, I’ll offer a slightly expanded commentary about the new library. For the ten-minute video explanation, see the <a href="http://www.youtube.com/watch?v=MYtm9YG4tMM">Youtube</a> video. The accompanying slides are available <a href="http://www.ccs.neu.edu/home/asumu/slides/racketcon-2012-generics.pdf">here</a>.</p>

<h2 id="introduction">Introduction</h2>

<p>Probably the first question that comes to your mind is: what are generics and what do we mean by generic programming? Let me illustrate with some example code:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">vector-ref#</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span><span class="mi">2</span><span class="p">)</span>
<span class="mi">3</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._list-ref))" style="color: inherit">list-ref</a></span><span class="o">'</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span><span class="mi">2</span><span class="p">)</span>
<span class="mi">3</span>
</pre></div>

</div>

<p>Both of the lines above operate on sequence-like datatypes, but for each of the datatypes we use different functions: <code>vector-ref</code> and <code>list-ref</code>. This is also the case with other datatypes like dictionary-like datatypes: <code>hash-ref</code>, <code>assoc</code>, etc. Or all the different kinds of equality: <code>string=?</code>, <code>boolean=?</code>, and <code>=</code>. These specialized operations may seem redundant. Ideally, we’d have generic functions that don’t care about the specific datatypes that we operate over.</p>

<p>Thankfully, Racket does provide these. For dictionaries, we have functions like <code>dict-ref</code> and <code>dict-set</code> that operate over any kind of dictionary-like type. For sequences, <code>sequence-ref</code>, <code>sequence-append</code>, and so on. These generic interfaces are all built-in to the standard library. You might wonder, however, if you can define your own generic functions.</p>

<p>As of version 5.3, you just need to (require racket/generic) to get all the tools you need to define your own generic interface. In the rest of the article I’ll show you how to define your own generic interface and how to use it. If you’ve seen Rust’s <a href="http://pcwalton.github.com/blog/2012/08/08/a-gentle-introduction-to-traits-in-rust">traits</a> or Clojure’s <a href="http://clojure.org/protocols">protocols</a>, our design will feel familiar.</p>

<h2 id="examples">Examples</h2>

<p>The running example will be the implementation of a simple queue interface. Our queue will contain five operations: <code>queue-enqueue</code>, <code>queue-dequeue</code>, <code>queue-head</code>, <code>queue-empty?</code>, and <code>queue-length</code>.</p>

<p>The first thing to do is to require the library:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">requireracket/generic</span><span class="p">)</span>
</pre></div>

</div>

<p>Then we use define-generics to define a generic interface:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/reference/struct-generics.html#(form._((lib._racket/generic..rkt)._define-generics))" style="color: inherit">define-generics</a></span> <span class="n">queue</span>
    <span class="p">[</span><span class="n">queue-enqueue</span> <span class="n">queue</span> <span class="n">elem</span><span class="p">]</span>
    <span class="p">[</span><span class="n">queue-dequeue</span> <span class="n">queue</span><span class="p">]</span>
    <span class="p">[</span><span class="n">queue-head</span> <span class="n">queue</span><span class="p">]</span>
    <span class="p">[</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-empty~3f))" style="color: inherit">queue-empty?</a></span> <span class="n">queue</span><span class="p">]</span>
    <span class="p">[</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-length))" style="color: inherit">queue-length</a></span> <span class="n">queue</span><span class="p">])</span>
</pre></div>

</div>

<p>The method headers above define the methods that concrete implementations of the generic interface need to provide. Each header needs to contain at least one argument that matches the name of the interface; this argument will be used for dispatch. The form defines several identifiers: queue?, gen:queue, queue/c, and each of the generic functions. The first is a predicate that checks whether a given value implements the interface. The identifier prefixed with gen: is a binding that’s used to supply methods for the interface. The queue/c specifies a contract combinator for the interface, which I’ll describe later in the article.</p>

<p>We now have the generic functions, but they’re not very useful without concrete implementations. To implement a generic interface, you first need to define a structure type. We’ll define a simple functional queue(Okasaki 1998, p.42) that uses two lists:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span> <span class="n">simple-queue</span> <span class="p">(</span><span class="n">front</span> <span class="n">back</span><span class="p">)</span>
    <span class="kd">#:methods</span> <span class="n">gen:queue</span>
    <span class="p">[</span><span class="c1">; helper function to balance lists</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">check-front</span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">queue</span>
         <span class="p">[(</span><span class="n">simple-queue</span> <span class="o">'</span><span class="p">()</span> <span class="n">back</span><span class="p">)</span>
          <span class="p">(</span><span class="n">simple-queue</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/private/list..rkt)._reverse))" style="color: inherit">reverse</a></span> <span class="n">back</span><span class="p">)</span> <span class="o">'</span><span class="p">())]</span>
         <span class="p">[</span><span class="k"><a href="http://docs.racket-lang.org/reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt).__))" style="color: inherit">_</a></span> <span class="n">queue</span><span class="p">]))</span>
     <span class="c1">; enqueue an element</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">queue-enqueue</span> <span class="n">queue</span> <span class="n">elem</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">queue</span>
         <span class="p">[(</span><span class="n">simple-queue</span> <span class="n">front</span> <span class="n">back</span><span class="p">)</span>
          <span class="p">(</span><span class="n">check-front</span> <span class="p">(</span><span class="n">simple-queue</span> <span class="n">front</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">elem</span> <span class="n">back</span><span class="p">)))]))</span>
     <span class="c1">; dequeue an element</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">queue-dequeue</span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">queue</span>
         <span class="p">[(</span><span class="n">simple-queue</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">x</span> <span class="n">xs</span><span class="p">)</span> <span class="n">back</span><span class="p">)</span>
          <span class="p">(</span><span class="n">check-front</span> <span class="p">(</span><span class="n">simple-queue</span> <span class="n">xs</span> <span class="n">back</span><span class="p">))]))</span>
     <span class="c1">; get the head of the queue</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">queue-head</span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">queue</span>
         <span class="p">[(</span><span class="n">simple-queue</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._cons))" style="color: inherit">cons</a></span> <span class="n">x</span> <span class="n">xs</span><span class="p">)</span> <span class="n">back</span><span class="p">)</span> <span class="n">x</span><span class="p">]))</span>
     <span class="c1">; check if the queue is empty</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-empty~3f))" style="color: inherit">queue-empty?</a></span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((lib._racket/list..rkt)._empty~3f))" style="color: inherit">empty?</a></span> <span class="p">(</span><span class="n">simple-queue-front</span> <span class="n">queue</span><span class="p">)))</span>
     <span class="c1">; get the queue&#39;s length</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-length))" style="color: inherit">queue-length</a></span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="p">(</span><span class="n">simple-queue-front</span> <span class="n">queue</span><span class="p">))</span>
          <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/pairs.html#(def._((quote._~23~25kernel)._length))" style="color: inherit">length</a></span> <span class="p">(</span><span class="n">simple-queue-back</span> <span class="n">queue</span><span class="p">))))])</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">empty-queue</span>
    <span class="p">(</span><span class="n">simple-queue</span> <span class="o">'</span><span class="p">()</span> <span class="o">'</span><span class="p">()))</span>
</pre></div>

</div>

<p>Using the #:methods keyword and the gen:queue binding, we can specify the methods that a simple-queue implements. Note that a #:methods block may also contain helper functions (like check-front) and definitions that are used to define the methods. Each method has the same method header as the corresponding headers in the interface definition.</p>

<p>We can check that our new queue actually works with the generic functions:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">queue-head</span><span class="p">(</span><span class="n">queue-enqueueempty-queue5</span><span class="p">))</span>
<span class="mi">5</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">queue-empty?empty-queue</span><span class="p">)</span>
<span class="no">#t</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-length))" style="color: inherit">queue-length</a></span><span class="p">(</span><span class="n">queue-enqueue</span><span class="p">(</span><span class="n">queue-enqueueempty-queue7</span><span class="p">)</span><span class="mi">5</span><span class="p">))</span>
<span class="mi">2</span>
</pre></div>

</div>

<p>It works! For any structure type, we can define methods in the same way. For example, we can define an efficient persistent queue(Okasaki 1998, p.64) that implements the same methods. This time, the implementation will use lazy evaluation with streams:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._struct))" style="color: inherit">struct</a></span> <span class="n">persistent-queue</span> <span class="p">(</span><span class="n">front-len</span> <span class="n">front</span> <span class="n">back-len</span> <span class="n">back</span><span class="p">)</span>
    <span class="kd">#:methods</span> <span class="n">gen:queue</span>
    <span class="p">[</span><span class="c1">; helper function to balance lists</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">check</span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">queue</span>
         <span class="p">[(</span><span class="n">persistent-queue</span> <span class="n">front-len</span> <span class="n">front</span> <span class="n">back-len</span> <span class="n">back</span><span class="p">)</span>
          <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3c~3d))" style="color: inherit">&lt;=</a></span> <span class="n">back-len</span> <span class="n">front-len</span><span class="p">)</span>
              <span class="n">queue</span>
              <span class="p">(</span><span class="n">persistent-queue</span>
               <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="n">front-len</span> <span class="n">back-len</span><span class="p">)</span>
               <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/streams.html#(def._((lib._racket/stream..rkt)._stream-append))" style="color: inherit">stream-append</a></span> <span class="n">front</span> <span class="p">(</span><span class="n">stream-reverse</span> <span class="n">back</span><span class="p">))</span>
               <span class="mi">0</span> <span class="n">stream-null</span><span class="p">))]))</span>
     <span class="c1">; enqueue an element</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">queue-enqueue</span> <span class="n">queue</span> <span class="n">elem</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">queue</span>
         <span class="p">[(</span><span class="n">persistent-queue</span> <span class="n">front-len</span> <span class="n">front</span> <span class="n">back-len</span> <span class="n">back</span><span class="p">)</span>
          <span class="p">(</span><span class="n">check</span> <span class="p">(</span><span class="n">persistent-queue</span>
                  <span class="n">front-len</span> <span class="n">front</span>
                  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="mi">1</span> <span class="n">back-len</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/streams.html#(form._((lib._racket/stream..rkt)._stream-cons))" style="color: inherit">stream-cons</a></span> <span class="n">elem</span> <span class="n">back</span><span class="p">)))]))</span>
     <span class="c1">; dequeue an element</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">queue-dequeue</span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">queue</span>
         <span class="p">[(</span><span class="n">persistent-queue</span> <span class="n">front-len</span> <span class="n">front</span> <span class="n">back-len</span> <span class="n">back</span><span class="p">)</span>
          <span class="p">(</span><span class="n">check</span> <span class="p">(</span><span class="n">persistent-queue</span>
                  <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._-))" style="color: inherit">-</a></span> <span class="n">front-len</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/streams.html#(def._((lib._racket/stream..rkt)._stream-rest))" style="color: inherit">stream-rest</a></span> <span class="n">front</span><span class="p">)</span>
                  <span class="n">back-len</span> <span class="n">back</span><span class="p">))]))</span>
     <span class="c1">; get the head of the queue</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">queue-head</span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/match.html#(form._((lib._racket/match..rkt)._match))" style="color: inherit">match</a></span> <span class="n">queue</span>
         <span class="p">[(</span><span class="n">persistent-queue</span> <span class="n">front-len</span> <span class="n">front</span> <span class="n">back-len</span> <span class="n">back</span><span class="p">)</span>
          <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/streams.html#(def._((lib._racket/stream..rkt)._stream-first))" style="color: inherit">stream-first</a></span> <span class="n">front</span><span class="p">)]))</span>
     <span class="c1">; check if the queue is empty</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-empty~3f))" style="color: inherit">queue-empty?</a></span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3d))" style="color: inherit">=</a></span> <span class="mi">0</span> <span class="p">(</span><span class="n">persistent-queue-front-len</span> <span class="n">queue</span><span class="p">)))</span>
     <span class="c1">; get the queue&#39;s length</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-length))" style="color: inherit">queue-length</a></span> <span class="n">queue</span><span class="p">)</span>
       <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._+))" style="color: inherit">+</a></span> <span class="p">(</span><span class="n">persistent-queue-front-len</span> <span class="n">queue</span><span class="p">)</span>
          <span class="p">(</span><span class="n">persistent-queue-back-len</span> <span class="n">queue</span><span class="p">)))])</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">empty-persistent-queue</span>
    <span class="p">(</span><span class="n">persistent-queue</span> <span class="mi">0</span> <span class="n">stream-null</span> <span class="mi">0</span> <span class="n">stream-null</span><span class="p">))</span>
</pre></div>

</div>

<p>Our operations from before work as expected:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">queue-head</span><span class="p">(</span><span class="n">queue-enqueueempty-persistent-queue5</span><span class="p">))</span>
<span class="mi">5</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">queue-empty?empty-persistent-queue</span><span class="p">)</span>
<span class="no">#t</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-length))" style="color: inherit">queue-length</a></span><span class="p">(</span><span class="n">queue-enqueue</span><span class="p">(</span><span class="n">queue-enqueueempty-persistent-queue7</span><span class="p">)</span><span class="mi">5</span><span class="p">))</span>
<span class="mi">2</span>
</pre></div>

</div>

<h2 id="contracts">Contracts</h2>

<p>Earlier, I mentioned that the generic interface also comes with a contract form that’s automatically defined. You can use these to attach dynamic checks to your implementations.</p>

<p>For example, we can write a contract that restricts our queues to only accept integers as data elements:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">int-queue/c</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/contract-utilities.html#(form._((lib._racket/contract/private/base..rkt)._recursive-contract))" style="color: inherit">recursive-contract</a></span>
     <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue/c))" style="color: inherit">queue/c</a></span> <span class="p">[</span><span class="n">queue-enqueue</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="n">int-queue/c</span><span class="p">)]</span>
              <span class="p">[</span><span class="n">queue-dequeue</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="n">int-queue/c</span><span class="p">)]</span>
              <span class="p">[</span><span class="n">queue-head</span>    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span><span class="p">)]</span>
              <span class="p">[</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-empty~3f))" style="color: inherit">queue-empty?</a></span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)]</span>
              <span class="p">[</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-length))" style="color: inherit">queue-length</a></span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span><span class="p">)])))</span>
</pre></div>

</div>

<p>For the queue interface, the automatically defined queue/c combinator allows us to specify contracts on each of the methods in the interface. We also use a recursive contract here just so that we can reference the int-queue/c contract within itself.</p>

<p>We can apply the contract to a particular queue:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="n">checked-queue</span>
    <span class="n">int-queue/c</span>
    <span class="n">empty-queue</span><span class="p">)</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">queue-enqueue</span> <span class="n">checked-queue</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">#&lt;simple-queue&gt;</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">queue-enqueue</span> <span class="n">checked-queue</span> <span class="s2">"not an integer"</span><span class="p">)</span>
<span class="n">checked-queue:</span> <span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/private/base..rkt)._contract))" style="color: inherit">contract</a></span> <span class="n">violation</span>
 <span class="n">expected:</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span>
 <span class="n">given:</span> <span class="s2">"not an integer"</span>
 <span class="n">in:</span> <span class="n">the</span> <span class="n">2nd</span> <span class="n">argument</span> <span class="n">of</span>
     <span class="n">the</span> <span class="n">queue-enqueue</span> <span class="n">method</span> <span class="n">of</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/contract-utilities.html#(form._((lib._racket/contract/private/base..rkt)._recursive-contract))" style="color: inherit">recursive-contract</a></span>
       <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue/c))" style="color: inherit">queue/c</a></span>
        <span class="p">(</span><span class="n">queue-enqueue</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="n">int-queue/c</span><span class="p">))</span>
        <span class="p">(</span><span class="n">queue-dequeue</span>
         <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="n">int-queue/c</span><span class="p">))</span>
        <span class="p">(</span><span class="n">queue-head</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span><span class="p">))</span>
        <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-empty~3f))" style="color: inherit">queue-empty?</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">))</span>
        <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-length))" style="color: inherit">queue-length</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">int-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span><span class="p">))))</span>
 <span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/private/base..rkt)._contract))" style="color: inherit">contract</a></span> <span class="n">from:</span> <span class="p">(</span><span class="n">definition</span> <span class="n">checked-queue</span><span class="p">)</span>
 <span class="n">blaming:</span> <span class="n">top-level</span>
 <span class="n">at:</span> <span class="n">eval:15.0</span>
</pre></div>

</div>

<p>The second use of <code>queue-enqueue</code> causes a contract error as expected, since we can’t add a string to an integer queue. You can also provide a constructor for your integer queue that’s contracted to produce int-queue/cs. Any queues created with that constructor will be checked for integers.</p>

<p>Also, you might have noticed that the queues we wrote above don’t protect against dequeueing or taking the head of empty queues. To prevent this, we can write contracts that ensure these operations raise contract errors on empty queues. Since we want to enforce this for all queues instead of just some of them, we apply contracts to the generic functions:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">non-empty-queue/c</span>
    <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._flat-named-contract))" style="color: inherit">flat-named-contract</a></span>
     <span class="o">'</span><span class="ss">non-empty-queue</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/lambda.html#(form._((lib._racket/private/base..rkt)._~ce~bb))" style="color: inherit">λ</a></span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue~3f))" style="color: inherit">queue?</a></span> <span class="n">q</span><span class="p">)</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" style="color: inherit">not</a></span> <span class="p">(</span><span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue-empty~3f))" style="color: inherit">queue-empty?</a></span> <span class="n">q</span><span class="p">))))))</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">checked-dequeue</span> <span class="n">queue</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">non-empty-queue/c</span> <span class="n"><a href="http://docs.racket-lang.org/data/Imperative_Queues.html#(def._((lib._data/queue..rkt)._queue~3f))" style="color: inherit">queue?</a></span><span class="p">)</span>
    <span class="p">(</span><span class="n">queue-dequeue</span> <span class="n">queue</span><span class="p">))</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">checked-head</span> <span class="n">queue</span><span class="p">)</span>
    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">non-empty-queue/c</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)</span>
    <span class="p">(</span><span class="n">queue-head</span> <span class="n">queue</span><span class="p">))</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">checked-head</span> <span class="n">empty-persistent-queue</span><span class="p">)</span>
<span class="n">checked-head:</span> <span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/private/base..rkt)._contract))" style="color: inherit">contract</a></span> <span class="n">violation</span>
 <span class="n">expected:</span> <span class="n">non-empty-queue</span>
 <span class="n">given:</span> <span class="n">#&lt;persistent-queue&gt;</span>
 <span class="n">in:</span> <span class="n">the</span> <span class="n">1st</span> <span class="n">argument</span> <span class="n">of</span>
      <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">non-empty-queue</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span><span class="p">)</span>
 <span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/private/base..rkt)._contract))" style="color: inherit">contract</a></span> <span class="n">from:</span> <span class="p">(</span><span class="n">function</span> <span class="n">checked-head</span><span class="p">)</span>
 <span class="n">blaming:</span> <span class="n">top-level</span>
 <span class="n">at:</span> <span class="n">eval:20.0</span>
</pre></div>

</div>

<p>The <code>checked-head</code> function raises a contract error as expected instead of an exception from a stream function. In a real implementation, you would just export the original generic functions with contracts attached using contract-out instead of defining checked versions like we did here.</p>

<h2 id="summary">Summary</h2>

<p>Racket 5.3 has made the process of defining and using generic interfaces much easier. The new library is still under active development and we plan to experiment with additional features and performance improvements. The full code from this article can be found in the following gist: <a href="https://gist.github.com/3995200">https://gist.github.com/3995200</a></p>

<p>Bibliography:  Chris Okasaki. Purely Functional Data Structures. Cambridge University Press, 1998.</p></div>
  <a class="more" href='/2012/11/generics.html'>more →</a>
<col-2>

</row>

</article>
<article class="index" id="home">
<row>

<col-1>
  <p class='date-and-tags'>24 Oct 2012</p></col-1>

<col-2>
  <h1><a href='/2012/10/the-3n1-problem.html'>The 3n+1 problem</a></h1>
  <div class="truncate">
<p><em>posted by Danny Yoo</em></p>

<p>1<code>Introduction: 
I’m starting to go through
[Programming
Challenges: The Programming Contest Training Manual](http://www.amazon.com/exec/obidos/ASIN/0387001638/thealgorithmrepo), by Steven S. Skiena and
Miguel Revilla.  I thought it would be fun to show how to approach the problems
using the [Racket](http://racket-lang.org/) programming language.  Rather
than use a small, toy educational subset of the language, I’ll take off the kid
gloves, and use whatever’s available in
[#lang racket](http://docs.racket-lang.org/guide/index.html).


2</code>The problem:</p>

<p>The <a href="http://acm.uva.es/p/v1/100.html">3n+1</a> problem is as follows: consider a positive number n. The cycle length of n is the number of times we repeat the following, until we reach n=1:</p>

<ul>
 <li>
  <p>If n is odd, then n ⇐ 3n+1</p></li>
 <li>
  <p>If n is even, then n ⇐ n/2</p></li></ul>

<p>For example, given n=22, we see the following sequence: 22 11 34 17 52 26 13 40 20 10 5 16 8 4 2 1. The cycle length of 22 is, therefore, 16, since it took 16 repetitions to get to 1.</p>

<p>Given a definition of cycle length of a number, here’s the rest of the problem: given any two numbers i and j, compute the maximum cycle length over all numbers between i and j, inclusive.</p>

<p>2.1<code>The plan: 
Before we do any real coding, let’s figure out a plan of attack and how to test
that plan.



* We need a way of computing cycle-length.

* We need to run cycle-length over a range of values and pick out the biggest result.

It sounds like we may want a function called cycle-length that will
compute how long it takes for us to get n to 1.  If we have
cycle-length as a helper function, then it becomes a fairly direct
loop through the range between i and j to pick out which one produces the
largest cycle length.

Let’s first write up a stub function that computes some nonsense.  We’ll
correct it in a moment, of course!



;cycle-length: positive-integer -&gt; positive-integer
;Computes the cycle length of n, according to
;the 3n+1 rules.

&gt; (define(cycle-lengthn)
42)








This is certainly not right, but it’s a start.  And it’s something we can test!


3</code>Test cases:</p>

<p>We want</p>

<p>(cycle-length1)==&gt;1</p>

<p>Let’s express this more formally with the rackunit unit testing library in Racket.</p>

<p>;Load up rackunit: &gt; (requirerackunit)</p>

<p>;Let&rsquo;s express that test: &gt; (check-equal?(cycle-length1)1)</p>

<hr />

<p>FAILURE name: check-equal? location: (eval 4 0 4 1) expression: (check-equal? (cycle-length 1) 1) actual: 42 expected: 1</p>

<h2 id="check-failure">Check failure</h2>

<p>;A few more tests, according to the problem statement above: &gt; (check-equal?(cycle-length2)2)</p>

<hr />

<p>FAILURE name: check-equal? location: (eval 5 0 5 1) expression: (check-equal? (cycle-length 2) 2) actual: 42 expected: 2</p>

<h2 id="check-failure">Check failure</h2>

<blockquote>
 <p>(check-equal?(cycle-length4)3)</p></blockquote>

<hr />

<p>FAILURE name: check-equal? location: (eval 6 0 6 1) expression: (check-equal? (cycle-length 4) 3) actual: 42 expected: 3</p>

<h2 id="check-failure">Check failure</h2>

<blockquote>
 <p>(check-equal?(cycle-length5)6)</p></blockquote>

<hr />

<p>FAILURE name: check-equal? location: (eval 7 0 7 1) expression: (check-equal? (cycle-length 5) 6) actual: 42 expected: 6</p>

<h2 id="check-failure">Check failure</h2>

<blockquote>
 <p>(check-equal?(cycle-length22)16)</p></blockquote>

<hr />

<p>FAILURE name: check-equal? location: (eval 8 0 8 1) expression: (check-equal? (cycle-length 22) 16) actual: 42 expected: 16</p>

<h2 id="check-failure">Check failure</h2>

<p>All of our test cases fail. Hurrah!</p>

<p>4<code>A solution: 
Ok, now that we coded up the tests, let’s write a solution.  We can write out a
definition for cycle-length almost straight out of the problem
statement:




&gt; (define(cycle-lengthn)
(cond
[(=n1)
1]
[(odd?n)
(add1(cycle-length(add1(*3n))))]
[(even?n)
(add1(cycle-length(/n2)))]))






;Let us try it out on a few values:
&gt; (cycle-length1)
1
&gt; (cycle-length2)
2
&gt; (cycle-length22)
16


If we run this through our test suite, we should be fairly confident
that cycle-length is probably doing the right thing.
(... modulo crazy inputs into the function such as 0.  If we
want to guard against such inputs, we can use the features in
racket/contract.)


5</code>Optimizing cycle-length:  How fast is the performance for cycle-length? Let’s try timing it for a few values, using the time utility. We’ll run cycle-length for a range of numbers, and see how long it takes.</p>

<blockquote>
 <p>(time(for([i(in-range1100000)]) (cycle-lengthi)))</p></blockquote>

<p>cpu time: 890 real time: 889 gc time: 0</p>

<p>5.1<code>Introducing an accumulator: 
There are a few things we might do to improve the performance of this.  Having
the (add1 ...) in the definition, waiting until the recursion finishes
up, seems ok, but I’m curious to see whether writing the definition with an
explicit accumulator will help us.




&gt; (define(cycle-lengthn)
(cycle-length/accn1))






;Helper function:

&gt; (define(cycle-length/accnacc)
(cond
[(=n1)
acc]
[(odd?n)
(cycle-length/acc(add1(*3n))(add1acc))]
[(even?n)
(cycle-length/acc(/n2)(add1acc))]))











With this reformulation, how does this do now?





&gt; (time(for([i(in-range1100000)])
(cycle-lengthi)))


cpu time: 790 real time: 790 gc time: 0









This does help.  Although we do get an improvement, let’s drop this
version for now and go back to our previous definition since it’s
simpler—and because the next potential optimization will work better
on it!


5.2</code>Adding memoization:  Another thing that comes to mind is this: our first good version of cycle-length works recursively. More to the point: repeated use of cycle-length can reuse prior results that we computed earlier. Maybe memoization will help. Let’s try it out: we’ll keep a small table of results, and consult that to see if we’ve already encountered the solution before.</p>

<p>;We&rsquo;ll maintain a table of known results. &gt; (definetable(make-hash))</p>

<blockquote>
 <p>(define(cycle-lengthn) (cond ;Consult the table: [(hash-has-key?tablen) (hash-reftablen)] [else ;If we can&rsquo;t find it, compute it&hellip; (defineanswer (cond [(=n1) 1] [(odd?n) (add1(cycle-length(add1(*3n))))] [(even?n) (add1(cycle-length(/n2)))])) ;&hellip; and then put it into the table. (hash-set!tablenanswer) ;Don&rsquo;t forget to return the value back! answer]))</p></blockquote>

<p>Does the overhead of setting up this table pay for itself? Let’s see:</p>

<blockquote>
 <p>(time(for([i(in-range1100000)]) (cycle-lengthi)))</p></blockquote>

<p>cpu time: 217 real time: 217 gc time: 44</p>

<p>Hey, not bad at all! That’s significantly better.</p>

<p>We should make sure, of course, that all our test cases are running on this ok.</p>

<blockquote>
 <p>(check-equal?(cycle-length1)1)</p></blockquote>

<blockquote>
 <p>(check-equal?(cycle-length2)2)</p></blockquote>

<blockquote>
 <p>(check-equal?(cycle-length4)3)</p></blockquote>

<blockquote>
 <p>(check-equal?(cycle-length5)6)</p></blockquote>

<blockquote>
 <p>(check-equal?(cycle-length22)16)</p></blockquote>

<p>All’s quiet on the cycle-length front. The tests are all passing.</p>

<p>5.3<code>Advanced: abstracting memoization to a helper macro: 
It turns out that the kind of memoization we’ve done here can be lifted out, so
that we can easily perform it at will.  That is, what we’re doing is something
like the following:



Given a definition that we’d like to memoize:



* create a table for exclusive use by the definition, and

* slightly tweak the definition’s body so it consults the table
before going through computation.




In terms of Racket, we can say that like this:




;A little helper to centralize the memoization logic
;into a single rewrite rule:

&gt; (define-syntax-rule(define/memo(nameid)body...)
(begin
(definetable(make-hash))
(define(nameid)
(cond
[(hash-has-key?tableid)
(hash-reftableid)]
[else
(defineanswer(beginbody...))
(hash-set!tableidanswer)
answer]))))











This defines a small rewrite rule that expresses the idea of memoizing simple,
1-argument function definitions.  Once we have this define/memo, we
can rewrite cycle-length to use it:




&gt; (define/memo(cycle-lengthn)
(cond
[(=n1)
1]
[(odd?n)
(add1(cycle-length(add1(*3n))))]
[(even?n)
(add1(cycle-length(/n2)))]))








which is nice because it’s easy to read.


6</code>Cycling back to a loop:  Now that we have a fairly robust cycle-length function, we can do the rest of the problem. Given a range of numbers, we want to go through them, compute the cycle lengths, and pick out the biggest one.</p>

<p>We can try to write this directly with a for/list to create a list of all the cycle-lengths, and apply the max across that list. Let’s write this in code:</p>

<blockquote>
 <p>(define(max-cycle-length-rangeij) (applymax (for/list([n(in-rangei(add1j))]) ;(add1 j) for inclusion &hellip; (cycle-lengthi))))</p></blockquote>

<p>Let’s write a few test cases to make sure that this is computing the right thing:</p>

<p>;From the &ldquo;Sample Output&rdquo; section of ;http://acm.uva.es/p/v1/100.html &gt; (check-equal?(max-cycle-length-range110)20)</p>

<hr />

<p>FAILURE name: check-equal? location: (eval 31 0 31 1) expression: (check-equal? (max-cycle-length-range 1 10) 20) actual: 1 expected: 20</p>

<h2 id="check-failure">Check failure</h2>

<p>What?! Oh, whoops, I wasn’t using the n in the loop. Silly me. Let’s fix that.</p>

<blockquote>
 <p>(define(max-cycle-length-rangeij) (applymax (for/list([n(in-rangei(add1j))]) (cycle-lengthn))))</p></blockquote>

<p>Thank goodness for test cases.</p>

<p>Ok, let’s try that again.</p>

<blockquote>
 <p>(check-equal?(max-cycle-length-range110)20)</p></blockquote>

<blockquote>
 <p>(check-equal?(max-cycle-length-range100200)125)</p></blockquote>

<blockquote>
 <p>(check-equal?(max-cycle-length-range201210)89)</p></blockquote>

<blockquote>
 <p>(check-equal?(max-cycle-length-range9001000)174)</p></blockquote>

<p>All passing? Much better!</p>

<p>6.1<code>Advanced: maximizing a loop: 
It would be nice if we could directly express taking the maximum
across a for loop.  We’re performing the maximum computation
by first constructing a list of all the cycle lengths, then applying
max over the whole list.  Can we avoid that auxiliary list
construction, and just compute the max as we’re running through the
numbers?

In fact, there are several variations of for loops in Racket,
so maybe one of those variations will work for us.  For example, we
could use for/fold, which gives us enough expressive power to
take the maximum during iteration.




&gt; (for/fold([current-max-inf.0])
([n'(31415926)])
(if(&gt;ncurrent-max)ncurrent-max))


9


There are other versions of for loops, such as the one for
taking sums (for/sum).  But as of this writing, there doesn’t
seem to be be a for/max form that lets us take the maximum
directly.

The question arises: how difficult is it to build for/max?

It turns out that it’s not too bad, though it requires a little more macrology:
we’ll use for/fold/derived to express our own for/max loop in terms of folding:




&gt; (define-syntax(for/maxstx)
(syntax-casestx()
[(_clauses. defs+exprs)
(with-syntax([originalstx])
#'(for/fold/derivedoriginal
([current-max-inf.0])
clauses
(definemaybe-new-max
(let(). defs+exprs))
(if(&gt;maybe-new-maxcurrent-max)
maybe-new-max
current-max)))]))








Essentially, as we’re looping through numbers, we maintain a
current-max, and update that max accordingly as we walk
across the iteration.  The rest of the code in for/max
delegates the rest of the gruntwork to
for/fold (technically, for/fold/derived).

We must test this, of course:



;Edge case: if we take the maximum of no numbers,
;let's see -inf.0.

&gt; (check-equal?(for/max([i'()])
i)
-inf.0)







&gt; (check-equal?
(for/max([i'(31415926)])
i)
9)







&gt; (check-equal?
(for/max[(i(in-range123))]
i)
22)







&gt; (check-equal?
(for/max([n'(3.141592.718281.61803)]
[s'(-111)])
(*ns))
2.71828)






;... and of course...

&gt; (check-equal?
(for/max[(i(in-range900(add11000)))]
(cycle-lengthi))
174)








Looks good.  With this, let’s express max-cycle-length-range
in terms of for/max now:




&gt; (define(max-cycle-length-rangeij)
(for/max([n(in-rangei(add1j))])
(cycle-lengthn)))









7</code>Making a module:  Now that we have most of the solution worked out, let’s make a module that encapsulates what we’ve done. Let’s lift up the definitions that we used to make the solution nice and pretty, and place them into &ldquo;helpers.rkt&rdquo;:</p>

<p>&ldquo;helpers.rkt&rdquo;</p>

<h1 id="langracket">langracket</h1>

<p>(providefor/maxdefine/memo)</p>

<p>(define-syntax(for/maxstx) (syntax-casestx() [(_clauses.defs+exprs) (with-syntax([originalstx]) #&rsquo;(for/fold/derivedoriginal ([current-max-inf.0]) clauses (definemaybe-new-max (let().defs+exprs)) (if(&gt;maybe-new-maxcurrent-max) maybe-new-max current-max)))]))</p>

<p>(define-syntax-rule(define/memo(nameid)body&hellip;) (begin (definetable(make-hash)) (define(nameid) (cond [(hash-has-key?tableid) (hash-reftableid)] [else (defineanswer(beginbody&hellip;)) (hash-set!tableidanswer) answer]))))</p>

<p>(module+test (requirerackunit) (check-equal?(for/max([i&rsquo;()]) i) -inf.0) (check-equal?(for/max([i&rsquo;(31415926)]) i) 9) (check-equal?(for/max[(i(in-range123))] i) 22)</p>

<p>(check-equal? (for/max([n&rsquo;(3.141592.718281.61803)] [s&rsquo;(&ndash;111)]) (*ns)) 2.71828))</p>

<p>Who knows? We might reuse &ldquo;helpers.rkt&rdquo; sometime.</p>

<p>(You may note that the bottom of &ldquo;helpers.rkt&rdquo; contains a test submodule which collects the unit tests that we’ve written. We can run a module’s test suite by using <a href="http://docs.racket-lang.org/raco/test.html">raco test</a>.)</p>

<p>With our &ldquo;helpers.rkt&rdquo; in in hand, let’s put our solution in &ldquo;three-n-plus-one.rkt&rdquo;:</p>

<p>&ldquo;three-n-plus-one.rkt&rdquo;</p>

<h1 id="langracket">langracket</h1>

<p>(require"helpers.rkt")</p>

<p>(define/memo(cycle-lengthn) (cond [(=n1) 1] [(odd?n) (add1(cycle-length(add1(*3n))))] [(even?n) (add1(cycle-length(/n2)))]))</p>

<p>(define(max-cycle-length-rangeij) (for/max([n(in-rangei(add1j))]) (cycle-lengthn)))</p>

<p>(module+test (requirerackunit)</p>

<p>(check-equal?(cycle-length1)1) (check-equal?(cycle-length2)2) (check-equal?(cycle-length4)3) (check-equal?(cycle-length5)6) (check-equal?(cycle-length22)16)</p>

<p>(check-equal? (max-cycle-length-range110)20) (check-equal? (max-cycle-length-range100200)125) (check-equal? (max-cycle-length-range201210)89) (check-equal? (max-cycle-length-range9001000)174) (check-equal? (for/max[(i(in-range900(add11000)))] (cycle-lengthi)) 174))</p>

<p>8<code>Integrating with I/O and a main: 
Finally, all this unit testing is fine and dandy, but we don’t
actually read input from standard input.  Let’s fix that, and modify
"three-n-plus-one.rkt" so it can be run as the main
entry point.




We can read individual lines as strings by iterating across
current-input-port with in-lines:




(for([line(in-lines(current-input-port))])...)


Once we have a line in hand, we can parse out the individual chunks
with read.  read doesn’t normally read from strings
directly, so we first translate each string into a port-like value
using open-input-string.

Last of all, let’s add the following to the bottom of
"three-n-plus-one.rkt":



(module+main
(for([line(in-lines(current-input-port))])
(defineline-port(open-input-stringline))
(definei(readline-port))
(definej(readline-port))
(when(and(number?i)(number?j))
(printf"~a ~a ~a\n"
ij
(max-cycle-length-rangeij)))))


This defines a main submodule.  When we run
"three-n-plus-one.rkt" directly from the command line, it will
run main:



$ cat sample-data.txt
1 10
100 200
201 210
900 1000

$ racket three-n-plus-one.rkt &lt; sample-data.txt
1 10 20
100 200 125
201 210 89
900 1000 174



9</code>The files:</p>

<ul>
 <li>
  <p><a href="http://hashcollision.org/three-n-plus-one/helpers.rkt">helpers.rkt</a></p></li>
 <li>
  <p><a href="http://hashcollision.org/three-n-plus-one/three-n-plus-one.rkt">three-n-plus-one.rkt</a></p></li></ul></div>
  <a class="more" href='/2012/10/the-3n1-problem.html'>more →</a>
<col-2>

</row>

</article>
<footer>
 <ul class="pagination">
  <li><a href="/index-3.html">
    <quote>&larr;</quote></a></li>
  <li><a href="/index.html">1</a></li>
  <li><a href="/index-2.html">2</a></li>
  <li><a href="/index-3.html">3</a></li>
  <li class="active"><a href="/index-4.html">4</a></li>
  <li><a href="/index-5.html">5</a></li>
  <li><a href="/index-6.html">6</a></li>
  <li><a href="/index-7.html">7</a></li>
  <li><a href="/index-8.html">8</a></li>
  <li><a href="/index-9.html">9</a></li>
  <li><a href="/index-10.html">10</a></li>
  <li><a href="/index-11.html">11</a></li>
  <li><a href="/index-12.html">12</a></li>
  <li><a href="/index-13.html">13</a></li>
  <li><a href="/index-14.html">14</a></li>
  <li><a href="/index-5.html">
    <quote>&rarr;</quote></a></li></ul></footer>

<row class="one-column" id="bottom"><col-1></col-1><col-2>
<p>Made with <a href="https://github.com/greghendershott/frog">Frog</a>, a static-blog generator written in Racket.
<br /><a href="https://github.com/racket/racket-lang-org">Source code</a> for this blog.</col-2></row>
  </body>
</html>