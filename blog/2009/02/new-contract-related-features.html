<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>New Contract-Related Features</title>
    <meta name="description" content="_posted by Stevie_  In SVN I've added three new major features that involve contracts. One allows for more fine-grained control of contracts, and the other two allow for the use of contracts with signatures and units.  Contract Regions:  _Contract regions...">
    <meta name="author"      content="The Unknown Author">
    <meta name="keywords"    content="">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="http://blog.racket-lang.org/2009/02/new-contract-related-features.html">
    <link rel="next" href="/2009/01/cfp-scheme-workshop-2009.html">
    <link rel="prev" href="/2009/02/steering-scheme.html">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/blog-fonts.css">
    <!-- Feeds -->
    <link rel="alternate" type="application/atom+xml" href="/feeds/all.atom.xml" title="Atom Feed">
    <link rel="alternate" type="application/rss+xml" href="/feeds/all.rss.xml" title="RSS Feed">
    <!-- JS -->
    </head>
  <body>
<row class="one-column" id="logo"><col-1><a href="http://racket-lang.org"><div id="logo-container"><img id="logo" src="/img/racket-logo.svg"/> Racket</div></a></col-1><col-2><p><a href="/index.html">blog</a></p></col-2></row>
<article>
<row>

<col-1>
  <p class='date-and-tags'>14 Feb 2009</p>

</col-1>

<col-2>
  <header>
  <h1>New Contract-Related Features</h1>
  </header>

<p><em>posted by Stevie</em></p>

<p>In SVN I&rsquo;ve added three new major features that involve contracts. One allows for more fine-grained control of contracts, and the other two allow for the use of contracts with signatures and units.</p>

<h2 id="contract-regions">Contract Regions</h2>

<p><em>Contract regions</em> allow the programmer to protect a region of code with a contract boundary. In addition to the wrapped code, the programmer also provides a name for the region which is used in blame situations and a list of exported variables which can either be protected with contracts or unprotected. The region provides a true contract boundary, in that uses of contracted exports within the region are unprotected. Contract regions are specified with the <code>with-contract</code> form. The following contract region defines two mutually recursive functions:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._with-contract))" style="color: inherit">with-contract</a></span> <span class="n">region1</span>
 <span class="p">([</span><span class="n">f</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)]</span>
  <span class="p">[</span><span class="n">g</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)])</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">f</span> <span class="n">n</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" style="color: inherit">zero?</a></span> <span class="n">n</span><span class="p">)</span> <span class="no">#f</span> <span class="p">(</span><span class="n">g</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="n">n</span><span class="p">))))</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">g</span> <span class="n">n</span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" style="color: inherit">zero?</a></span> <span class="n">n</span><span class="p">)</span> <span class="no">#t</span> <span class="p">(</span><span class="n">f</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="n">n</span><span class="p">)))))</span>
 <span class="o">```</span>

<span class="ss">The</span> <span class="n">internal</span> <span class="n">calls</span> <span class="n">to</span> <span class="o">`</span><span class="ss">f</span><span class="o">`</span> <span class="ss"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="o">`</span><span class="ss">g</span><span class="o">`</span> <span class="ss">are</span> <span class="n">uncontracted</span><span class="o">,</span> <span class="n">but</span> <span class="n">calls</span> <span class="n">to</span> <span class="o">`</span><span class="ss">f</span><span class="o">`</span><span class="ss"><a href="http://docs.racket-lang.org/reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._and))" style="color: inherit">and</a></span> <span class="o">`</span><span class="ss">g</span><span class="o">`</span> <span class="ss">outside</span> <span class="k"><a href="http://docs.racket-lang.org/reference/createclass.html#(form._((lib._racket/private/class-internal..rkt)._this))" style="color: inherit">this</a></span> <span class="n">region</span> <span class="n">would</span> <span class="n">be</span> <span class="n">appropriately</span> <span class="n">contracted.</span>  <span class="n">First-order</span> <span class="n">checks</span> <span class="n">are</span> <span class="n">performed</span> <span class="n">at</span> <span class="n">the</span> <span class="n">region</span><span class="o">,</span> <span class="n">so</span> <span class="n">the</span>
<span class="n">following</span> <span class="n">region:</span>

<span class="o">```</span><span class="ss">racket</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._with-contract))" style="color: inherit">with-contract</a></span> <span class="n">region2</span>
 <span class="p">([</span><span class="n">n</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span><span class="p">])</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="n">n</span> <span class="no">#t</span><span class="p">))</span>
 <span class="o">```</span>

<span class="ss">results</span> <span class="n">in</span> <span class="n">the</span> <span class="n">following</span> <span class="n">error:</span>

<span class="o">```</span><span class="ss">racket</span>
<span class="p">(</span><span class="n">region</span> <span class="n">region2</span><span class="p">)</span> <span class="n">broke</span> <span class="n">the</span> <span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/private/base..rkt)._contract))" style="color: inherit">contract</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span> <span class="n">on</span> <span class="n">n</span><span class="c1">; expected &lt;number?&gt;, given: #t</span>
</pre></div>

</div>

<p>Notice that the blame not only gives the name of the region, but describes what type of contract boundary was involved.</p>

<p>For contracting a single definition, there is the <code>define/contract</code> form which has a similar syntax to define, except that it takes a contract before the body of the definition.</p>

<p>To compare the two forms, the following two definitions are equivalent:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._with-contract))" style="color: inherit">with-contract</a></span> <span class="n">fact</span>
 <span class="p">([</span><span class="n">fact</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span><span class="p">)])</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">fact</span> <span class="n">n</span><span class="p">)</span>
   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" style="color: inherit">zero?</a></span> <span class="n">n</span><span class="p">)</span> <span class="mi">1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">n</span> <span class="p">(</span><span class="n">fact</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="n">n</span><span class="p">))))))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">fact</span> <span class="n">n</span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" style="color: inherit">zero?</a></span> <span class="n">n</span><span class="p">)</span> <span class="mi">1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">n</span> <span class="p">(</span><span class="n">fact</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="n">n</span><span class="p">)))))</span>
</pre></div>

</div>

<p>First order checks are similarly performed at the definition for <code>define/contract</code>, so</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="p">(</span><span class="n">fact</span> <span class="n">n</span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/if.html#(form._((quote._~23~25kernel)._if))" style="color: inherit">if</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._zero~3f))" style="color: inherit">zero?</a></span> <span class="n">n</span><span class="p">)</span> <span class="mi">1</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._*))" style="color: inherit">*</a></span> <span class="n">n</span> <span class="p">(</span><span class="n">fact</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._sub1))" style="color: inherit">sub1</a></span> <span class="n">n</span><span class="p">)))))</span>
</pre></div>

</div>

<p>results in</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="n">function</span> <span class="n">fact</span><span class="p">)</span> <span class="n">broke</span> <span class="n">the</span> <span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/private/base..rkt)._contract))" style="color: inherit">contract</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._number~3f))" style="color: inherit">number?</a></span><span class="p">)</span> <span class="n">on</span> <span class="n">fact</span><span class="c1">; expected a procedure that accepts no arguments without any keywords, given: #&lt;procedure:fact&gt;</span>
</pre></div>

</div>

<h2 id="signature-contracts">Signature Contracts</h2>

<p>In addition to contract regions, units are also now contract boundaries. One way to use contracts with units is to add contracts to unit signatures via the contracted <code>signature</code> form.</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._define-signature))" style="color: inherit">define-signature</a></span> <span class="n">toy-factory^</span>
 <span class="p">((</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._contracted))" style="color: inherit">contracted</a></span>
   <span class="p">[</span><span class="n">build-toys</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">toy?</span><span class="p">))]</span>
   <span class="p">[</span><span class="n">repaint</span>    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span> <span class="n">toy?</span><span class="p">)]</span>
   <span class="p">[</span><span class="n">toy?</span>       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)]</span>
   <span class="p">[</span><span class="n">toy-color</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span><span class="p">)])))</span>
</pre></div>

</div>

<p>Notice that contracts in a signature can use variables listed in the signature.Now if we take the following implementation of that signature:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/linkinference.html#(form._((lib._racket/unit..rkt)._define-unit))" style="color: inherit">define-unit</a></span> <span class="n">simple-factory@</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span> <span class="n">toy-factory^</span><span class="p">)</span>

 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._define-struct))" style="color: inherit">define-struct</a></span> <span class="n">toy</span> <span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="kd">#:transparent</span><span class="p">)</span>

 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">build-toys</span> <span class="n">n</span><span class="p">)</span>
   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="n">n</span><span class="p">)])</span>
     <span class="p">(</span><span class="n">make-toy</span> <span class="o">'</span><span class="ss">blue</span><span class="p">)))</span>

 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">repaint</span> <span class="n">t</span> <span class="n">col</span><span class="p">)</span>
   <span class="p">(</span><span class="n">make-toy</span> <span class="n">col</span><span class="p">)))</span>
</pre></div>

</div>

<p>We get the appropriate contract checks on those exports:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/linkinference.html#(form._((lib._racket/unit..rkt)._define-values/invoke-unit/infer))" style="color: inherit">define-values/invoke-unit/infer</a></span> <span class="n">simple-factory@</span><span class="p">)</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">build-toys</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="o">#</span><span class="p">(</span><span class="ss">struct:toy</span> <span class="ss">blue</span><span class="p">)</span> <span class="o">#</span><span class="p">(</span><span class="ss">struct:toy</span> <span class="ss">blue</span><span class="p">)</span> <span class="o">#</span><span class="p">(</span><span class="ss">struct:toy</span> <span class="ss">blue</span><span class="p">))</span>
<span class="nb"><a href="http://docs.racket-lang.org/reference/generic-numbers.html#(def._((quote._~23~25kernel)._~3e))" style="color: inherit">&gt;</a></span> <span class="p">(</span><span class="n">build-toys</span> <span class="no">#f</span><span class="p">)</span>
<span class="n">top-level</span> <span class="n">broke</span> <span class="n">the</span> <span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/private/base..rkt)._contract))" style="color: inherit">contract</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">toy?</span><span class="p">))</span>
 <span class="n">on</span> <span class="n">build-toys</span><span class="c1">; expected &gt;, given: #f</span>
</pre></div>

</div>

<p>As before, uses of contracted exports inside the unit are not checked.</p>

<p>Since units are contract boundaries, they can be blamed appropriately. Take the following definitions:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/linkinference.html#(form._((lib._racket/unit..rkt)._define-unit))" style="color: inherit">define-unit</a></span> <span class="n">factory-user@</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span> <span class="n">toy-factory^</span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/let.html#(form._((lib._racket/private/letstx-scheme..rkt)._let))" style="color: inherit">let</a></span> <span class="p">([</span><span class="n">toys</span> <span class="p">(</span><span class="n">build-toys</span> <span class="mi">3</span><span class="p">)])</span>
   <span class="p">(</span><span class="n">repaint</span> <span class="mi">3</span> <span class="o">'</span><span class="ss">blue</span><span class="p">)))</span>

<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/linkinference.html#(form._((lib._racket/unit..rkt)._define-compound-unit/infer))" style="color: inherit">define-compound-unit/infer</a></span> <span class="n">factory+user@</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._link))" style="color: inherit">link</a></span> <span class="n">simple-factory@</span> <span class="n">factory-user@</span><span class="p">))</span>
<span class="n">When</span> <span class="n">we</span> <span class="n">invoke</span> <span class="n">the</span> <span class="n">combined</span> <span class="n">unit:&gt;</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/linkinference.html#(form._((lib._racket/unit..rkt)._define-values/invoke-unit/infer))" style="color: inherit">define-values/invoke-unit/infer</a></span> <span class="n">factory+user@</span><span class="p">)</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._unit))" style="color: inherit">unit</a></span> <span class="n">factory-user@</span><span class="p">)</span> <span class="n">broke</span> <span class="n">the</span> <span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/private/base..rkt)._contract))" style="color: inherit">contract</a></span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span> <span class="n">toy?</span><span class="p">)</span>
<span class="n">on</span> <span class="n">repaint</span><span class="c1">; expected &gt;, given: 3</span>
</pre></div>

</div>

<h2 id="unit-contracts">Unit Contracts</h2>

<p>However, we may not always be able to add contracts to signatures. For example, there are many already-existing signatures in PLT Scheme that one may want to implement, or a programmer may want to take a unit value and add contracts to it after the fact.</p>

<p>To do this, there is the <code>unit/c</code> contract combinator. It takes a list of imports and exports, where each signature is paired with a list of variables and their contracts for each signature. So if we had the uncontracted version of the toy-factory^ signature:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._define-signature))" style="color: inherit">define-signature</a></span> <span class="n">toy-factory^</span>
 <span class="p">(</span><span class="n">build-toys</span> <span class="n">repaint</span> <span class="n">toy?</span> <span class="n">toy-color</span><span class="p">))</span>
</pre></div>

</div>

<p>the following contracts would be appropriate for a unit that imports nothing and exports that signature:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/unitcontracts.html#(form._((lib._racket/unit..rkt)._unit/c))" style="color: inherit">unit/c</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/unitcontracts.html#(form._((lib._racket/unit..rkt)._unit/c))" style="color: inherit">unit/c</a></span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span> <span class="n">toy-factory^</span><span class="p">))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/unitcontracts.html#(form._((lib._racket/unit..rkt)._unit/c))" style="color: inherit">unit/c</a></span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span> <span class="p">(</span><span class="n">toy-factory^</span>
          <span class="p">[</span><span class="n">toy-color</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span><span class="p">)])))</span>
<span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/unitcontracts.html#(form._((lib._racket/unit..rkt)._unit/c))" style="color: inherit">unit/c</a></span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span> <span class="p">(</span><span class="n">toy-factory^</span>
          <span class="p">[</span><span class="n">build-toys</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">toy?</span><span class="p">))]</span>
          <span class="p">[</span><span class="n">repaint</span>    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span> <span class="n">toy?</span><span class="p">)]</span>
          <span class="p">[</span><span class="n">toy?</span>       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)]</span>
          <span class="p">[</span><span class="n">toy-color</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span><span class="p">)])))</span>
</pre></div>

</div>

<p>Unit contracts can contain a superset of the import signatures and a subset of the export signatures for a given unit value. Also, variables that are not listed for a given signature are left alone when the contracts are being added.</p>

<p>Since the results of applying <code>unit/c</code> is a new unit, then adding a contract can cause link inference to fail. For example, if we change the definition of <code>simple-factory@</code> above to</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/attaching-contracts-to-values.html#(form._((lib._racket/contract/region..rkt)._define/contract))" style="color: inherit">define/contract</a></span> <span class="n">simple-factory@</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/unitcontracts.html#(form._((lib._racket/unit..rkt)._unit/c))" style="color: inherit">unit/c</a></span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span>
  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span> <span class="p">(</span><span class="n">toy-factory^</span>
           <span class="p">[</span><span class="n">build-toys</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">toy?</span><span class="p">))]</span>
           <span class="p">[</span><span class="n">repaint</span>    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span> <span class="n">toy?</span><span class="p">)]</span>
           <span class="p">[</span><span class="n">toy?</span>       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)]</span>
           <span class="p">[</span><span class="n">toy-color</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span><span class="p">)])))</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._unit))" style="color: inherit">unit</a></span>
   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span>
   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span> <span class="n">toy-factory^</span><span class="p">)</span>

   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._define-struct))" style="color: inherit">define-struct</a></span> <span class="n">toy</span> <span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="kd">#:transparent</span><span class="p">)</span>

   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">build-toys</span> <span class="n">n</span><span class="p">)</span>
     <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="n">n</span><span class="p">)])</span>
       <span class="p">(</span><span class="n">make-toy</span> <span class="o">'</span><span class="ss">blue</span><span class="p">)))</span>

   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">repaint</span> <span class="n">t</span> <span class="n">col</span><span class="p">)</span>
     <span class="p">(</span><span class="n">make-toy</span> <span class="n">col</span><span class="p">))))</span>
</pre></div>

</div>

<p>Then when we try to combine it with the <code>factory-user@</code> unit, we get:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="n">define-compound-unit/infer:</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._not))" style="color: inherit">not</a></span> <span class="n">a</span> <span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._unit))" style="color: inherit">unit</a></span> <span class="n">definition</span> <span class="n">in:</span> <span class="n">simple-factory@</span>
</pre></div>

</div>

<p>One way to solve this is to use <code>define-unit-binding</code> to set up the static information for the new contracted value. Another possibility for unit definitions is to use <code>define-unit/contract</code>:</p>

<div class="brush: racket">
 <div class="pygments">
  <pre><span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/unitcontracts.html#(form._((lib._racket/unit..rkt)._define-unit/contract))" style="color: inherit">define-unit/contract</a></span> <span class="n">simple-factory@</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._import))" style="color: inherit">import</a></span><span class="p">)</span>
 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/creatingunits.html#(form._((lib._racket/unit..rkt)._export))" style="color: inherit">export</a></span> <span class="p">(</span><span class="n">toy-factory^</span>
          <span class="p">[</span><span class="n">build-toys</span> <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/number-types.html#(def._((quote._~23~25kernel)._integer~3f))" style="color: inherit">integer?</a></span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/base..rkt)._listof))" style="color: inherit">listof</a></span> <span class="n">toy?</span><span class="p">))]</span>
          <span class="p">[</span><span class="n">repaint</span>    <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span> <span class="n">toy?</span><span class="p">)]</span>
          <span class="p">[</span><span class="n">toy?</span>       <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/data-structure-contracts.html#(def._((lib._racket/contract/private/misc..rkt)._any/c))" style="color: inherit">any/c</a></span> <span class="nb"><a href="http://docs.racket-lang.org/reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" style="color: inherit">boolean?</a></span><span class="p">)]</span>
          <span class="p">[</span><span class="n">toy-color</span>  <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/function-contracts.html#(form._((lib._racket/contract/base..rkt)._-~3e))" style="color: inherit">-&gt;</a></span> <span class="n">toy?</span> <span class="nb"><a href="http://docs.racket-lang.org/reference/symbols.html#(def._((quote._~23~25kernel)._symbol~3f))" style="color: inherit">symbol?</a></span><span class="p">)]))</span>

 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define-struct.html#(form._((lib._racket/private/base..rkt)._define-struct))" style="color: inherit">define-struct</a></span> <span class="n">toy</span> <span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="kd">#:transparent</span><span class="p">)</span>

 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">build-toys</span> <span class="n">n</span><span class="p">)</span>
   <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/for.html#(form._((lib._racket/private/base..rkt)._for/list))" style="color: inherit">for/list</a></span> <span class="p">([</span><span class="n">i</span> <span class="p">(</span><span class="nb"><a href="http://docs.racket-lang.org/reference/sequences.html#(def._((lib._racket/private/base..rkt)._in-range))" style="color: inherit">in-range</a></span> <span class="n">n</span><span class="p">)])</span>
     <span class="p">(</span><span class="n">make-toy</span> <span class="o">'</span><span class="ss">blue</span><span class="p">)))</span>

 <span class="p">(</span><span class="k"><a href="http://docs.racket-lang.org/reference/define.html#(form._((lib._racket/private/base..rkt)._define))" style="color: inherit">define</a></span> <span class="p">(</span><span class="n">repaint</span> <span class="n">t</span> <span class="n">col</span><span class="p">)</span>
   <span class="p">(</span><span class="n">make-toy</span> <span class="n">col</span><span class="p">)))</span>
</pre></div>

</div>

<p>More about these features can be found in the Reference, and a short section about signature and unit contracts has been added to the Guide.</p>
<col-2>

</row>

<footer>
<row>
<col-1>
</col-1>
<col-2>
<h2><span class="label">next</span> <a class="next" href="/2009/02/steering-scheme.html">Steering Scheme</a></h2>

<h2><span class="label">prev</span> <a class="previous" href="/2009/01/cfp-scheme-workshop-2009.html">CfP: Scheme Workshop 2009!</a></h2>

</col-2>
</row>
</footer>

</article>

<row class="one-column" id="bottom"><col-1></col-1><col-2>
<p>Made with <a href="https://github.com/greghendershott/frog">Frog</a>, a static-blog generator written in Racket.
<br /><a href="https://github.com/racket/racket-lang-org">Source code</a> for this blog.</col-2></row>
  </body>
</html>